# Scholar AI Agent 产品需求文档 (PRD)

## 目录

1. [产品概述](#1-产品概述)
2. [核心功能需求](#2-核心功能需求)
3. [前端交互设计](#3-前端交互设计)
4. [非功能需求](#4-非功能需求)
5. [实施计划与验收标准](#5-实施计划与验收标准)
6. [风险控制](#6-风险控制)

---

## 1. 产品概述

### 1.1 产品基本信息

| 属性 | 内容 |
|------|------|
| **产品名称** | Scholar Agent |
| **中文名称** | 智能学术助手 |
| **产品愿景** | 让每一位研究者都能享受智能化的学术研究支持 |
| **产品定位** | AI驱动的学术研究辅助平台，专为科研人员、学者和研究生设计 |

### 1.2 核心贡献

1. **架构设计**：通过 ReAct Agent 构建多智能体系统，实现任务协同执行
2. **任务驱动机制**：基于 TODO 范式驱动任务流转，引入 Human-In-The-Loop 反思机制
3. **多源检索**：集成 arXiv、学术搜索引擎、本地文档库等多源检索
4. **多模态信息处理**：使用 VLM（视觉语言模型）实现文档结构化
5. **多路检索链路**：设计"三路召回-加权合并-交叉重排"的检索链路
6. **检索效果优化**：Hybrid 混合检索、Multi Query 策略、Self-Reflection 机制

### 1.4 技术栈

| 技术 | 选型 | 说明 |
|------|------|------|
| Web 框架 | FastAPI | 高性能异步 Web 框架 |
| Agent 编排 | 纯 Python 状态机 | 自研 Orchestrator → Planner → Executor → Reflector 循环 |
| 实时推送 | SSE (Server-Sent Events) | 向客户端实时推送执行进度 |
| 前端框架     | Next.js 14 + TypeScript + Tailwind CSS | 响应式 Web 界面容 API                                   |
| 关系型数据库 | SQLite | 会话、消息、文档元数据、用户资料、用量记录 |
| 文件存储 | 本地文件系统 (MVP) / MinIO (后续) | 文档与多媒体文件存储 |

## 2. 核心功能需求

> **优先级说明**：P0 = MVP 必须实现，P1 = V1.0 实现，P2 = V2.0 实现

### 2.1 学术研究助手 Agent (P0)

**功能描述**：面向复杂科研任务的智能体系统，可自动完成从检索到综述的完整流程。

**核心能力**：
- **任务规划** (P0)：将用户复杂目标拆分为可执行 TODO 列表，每步指定工具和完成条件
- **多源检索** (P0)：集成 arXiv、学术搜索引擎、本地文档库等多源检索
- **文献筛选** (P0)：自动筛选高相关性、高质量文献
- **主题归纳** (P0)：对文献进行主题聚类和归纳总结
- **引用管理** (P0)：自动提取引用并格式化（GB/T 7714、APA等）
- **写作辅助** (P1)：生成文献综述提纲、摘要、完整内容
- **质量校验** (P1)：对结果进行事实一致性和引用完整性检查
- **多模态理解** (P1)：支持文本、公式、图像、表格的统一理解与问答

**用户故事**：
> 作为一名研究生，我希望系统能帮我自动完成"多模态检索"方向的文献综述，包括检索、筛选、归纳和写作，这样我可以节省大量时间。

### 2.2 文档管理与知识库 (P0/P1)

**功能描述**：个人文献库的上传、管理、检索功能。

**核心能力**：
- **文档上传** (P0)：支持 PDF、Word、Markdown 等多种格式的上传
- **元数据提取** (P0)：自动提取文档元数据（标题、作者、年份），建立索引
- **文件夹管理** (P0)：提供灵活的文件夹分类管理
- **检索能力** (P1)：支持全文检索和语义检索

**用户故事**：
> 作为一名研究生，我希望能把收集的所有论文上传到系统，并按研究方向分类管理，这样我可以快速找到需要的文献。

### 2.3 多模态 RAG 问答 (P1)

**功能描述**：支持对上传文档的文本、公式、图像、表格进行统一理解与问答。

**核心能力**：
- **文档解析**：支持 PDF、Word 等多种文档格式的解析与结构化
- **多模态提取**：实现文本、公式、图像、表格的多模态统一理解
- **三路召回**：文字-文字 / 文字-图像 / 文字-半结构化的检索能力
- **多轮对话**：支持基于文档内容的多轮对话
- **引用溯源**：确保回答的准确性和可追溯性

**用户故事**：
> 作为一名研究者，我希望能上传一篇复杂的论文，然后就论文中的架构图、公式等内容进行提问，这样我可以更快地理解论文核心内容。

### 2.4 文档内容编辑 (P0)

**功能描述**：支持对上传的文档内容进行查看和编辑，包括 Markdown、Text、Word 格式。

**核心能力**：
- **文档内容查看** (P0)：读取并显示文档文本内容
- **内容编辑** (P0)：支持在线编辑文档内容，保存后更新文件
- **Agent 编辑** (P0)：Agent 模式下可使用 DocEditTool 对选中文档进行增删改查操作

**用户故事**：
> 作为一名研究生，我希望能在系统中查看和编辑上传的论文笔记，并让 AI 帮我润色和补充内容。

### 2.5 个性化推荐与用户画像 (P2)

**功能描述**：基于用户历史行为构建用户画像，提供个性化内容推荐。

> **注意**：该功能依赖用户行为数据积累，需在系统运行一段时间后才能生效，建议 V2.0 阶段实现。

**核心能力**：
- **用户画像**：自动构建用户研究兴趣画像
- **论文推荐**：推荐相关前沿论文
- **方向推荐**：推荐相关研究方向和热点
- **内容深度**：根据用户知识水平调整内容深度

### 2.6 Human-In-The-Loop 人工干预 (P2)

**功能描述**：在关键节点支持人工确认和干预，提升结果可靠性。

**核心能力**：
- **任务规划确认**：可修改 Agent 生成的计划
- **检索结果筛选**：人工确认要使用的文献
- **中间结果审核**：可在关键步骤暂停并确认
- **最终结果编辑**：支持人工修改和补充

---

## 3. 前端交互设计

### 3.1 通用交互逻辑

- **首页设计**：打开系统直接进入智能助手页面（无独立首页）
- **全局导航**：顶部导航栏在所有页面保持一致，包含「智能助手」「文档管理」「个人中心」三个入口
- **聊天界面**：
  - 发送按钮旁边提供联网搜索开关（使用不同图标）
  - 提供普通问答和智能体模式的切换开关
  - 任务执行状态和结果直接在聊天对话框中显示
  - 聊天气泡长度与文字内容保持一致
  - 用户消息显示在右侧，助手消息显示在左侧
  - 点击新建对话按钮后清空对话框内容
  - 支持图片上传到对话中
  - 支持流式输出，提供更自然的对话体验

### 3.2 页面特定交互

#### 3.2.1 智能助手页面
- **布局**：顶部导航栏、左侧历史记录面板（可折叠）、中央聊天对话框、底部输入区域
- **功能**：新建对话、删除对话、模式切换（普通/智能体）、联网搜索开关、图片上传、SSE 流式输出
- **空状态**：无历史消息时居中显示品牌信息和 4 个快捷问题入口

#### 3.2.2 文档管理页面
- **布局**：顶部导航栏、左侧文件夹树、右侧主区域（上传区 + 搜索栏 + 文档列表 + 分页）
- **交互**：
  - 支持拖拽和点击两种上传方式，上传后自动刷新列表
  - 左侧提供「全部文档」入口和各文件夹入口，可新建/删除文件夹
  - 文档列表支持按文件名搜索（客户端过滤）
  - 每条文档显示文件名、大小、上传时间、文件类型，鼠标悬浮时显示删除按钮
  - 分页每页 10 条，支持页码切换

#### 3.2.3 个人中心页面
- **布局**：顶部导航栏、左侧（个人信息摘要卡片 + 账户卡片 + 用量统计卡片）、右侧（详细编辑面板 + 模型设置与充值面板）
- **交互**：
  - 个人信息支持查看/编辑模式切换，可编辑字段：显示名称、研究方向、所属机构、知识水平（下拉选择）、个人简介

#### 3.2.4 人工干预流程 (P2)
- **干预模式**：全自动模式、关键点确认模式
- **干预节点**：任务规划确认、检索结果筛选、最终结果编辑
- **交互**：
  - 任务规划确认：可查看、修改、添加、删除计划步骤
  - 检索结果筛选：可手动选择、批量选择文献
  - 最终结果编辑：可全文编辑、内容补充

### 3.3 交互反馈

- **实时进度**：通过 SSE 推送每个步骤的执行状态
- **视觉反馈**：
  - 检索中：加载动画
  - 思考中：跳动圆点提示
  - Agent 模式：任务计划卡片（含进度条）
  - 错误：错误提示信息
- **通知提醒**：
  - 干预提醒：到达干预节点时提醒用户 (P2)
  - 任务完成：任务完成时通知用户

---

## 4. 非功能需求

### 4.1 性能需求

| 指标 | MVP 目标值 | V1.0 目标值 | 说明 |
|------|-----------|------------|------|
| 首字响应延迟（TTFT） | < 3s | < 2s | 从发送到收到第一个流式字符 |
| 深度研究任务完成率 | > 80% | > 90% | Agent 模式能成功完成端到端任务 |
| 检索准确率 | Top6 > 70% | Top6 > 85% | 返回的前6条结果中相关的占比 |
| 并发用户数 | 10+ | 50+ | 同时进行对话的用户数 |
| 文档上传响应时间 | < 5s (10MB) | < 5s (10MB) | 文件上传接口响应时间 |
| 文档解析时间 | - | < 30s (100页PDF) | V1.0 引入文档解析 |

### 4.2 安全需求

| 需求项 | 详细说明 |
|--------|---------|
| **输入安全** | 防注入攻击、敏感词过滤、请求参数校验 |
| **过程安全** | 工具调用白名单、参数合法性校验、速率限制 |
| **输出安全** | 引用完整性检查、内容合规过滤 |
| **数据安全** | 用户数据分离存储、文件访问权限控制 |
| **隐私保护** | 数据最小化收集、不向第三方泄露用户文档内容 |

### 4.3 可观测性需求

| 需求项 | MVP | 详细说明 |
|--------|-----|------|
| **请求日志** | ✅ | 所有 API 请求的入参、出参、耗时 |
| **错误日志** | ✅ | 异常堆栈、错误上下文 |
| **全链路追踪** | ✅ | trace_id 贯穿整个任务执行流程 |
| **成本追踪** | ✅ | 按任务、用户统计费用和用量 |

### 4.4 可扩展性需求

- **工具插件化**：ToolHub 支持注册自定义工具，新增工具只需继承 BaseTool 基类
- **LLM 可替换**：可对接不同模型供应商
- **存储可升级**：MVP 用 SQLite + 本地文件，后续可平滑迁移到 PostgreSQL + MinIO + Milvus

---

## 5. 实施计划与验收标准

### 5.1 分阶段实施路线

| 阶段 | 内容 | 周期 | 基础设施 |
|------|------|------|---------|
| **MVP** | 单 Agent + 7 工具 + SQLite + SSE + Web 前端 + 费用管理 | 3-4周 | SQLite + 本地文件系统 |
| **V1.0** | 多模态 RAG + 向量检索 + 可观测性完善 | 4-6周 | + Milvus + MinIO |
| **V2.0** | Human-In-The-Loop + 个性化推荐 | 4-6周 | + Redis (可选) |

### 5.2 MVP 最小可行产品

**MVP 必须实现**：

| 模块 | MVP 必须 | 后续迭代 | 备注 |
|------|----------|----------|------|
| Orchestrator | ✅ | - | 核心入口 + SSE 流式 |
| Planner | ✅ 规则模板 | LLM 动态规划 | MVP 使用预设模板，配置 API Key 后使用 LLM |
| Executor | ✅ 串行执行 | 并行执行 | 按 TODO 列表逐步执行 |
| ToolHub | ✅ 7个工具 | 扩展更多 | Search/Filter/Summarize/Citation/MultiModalRAG/Doc/Profile |
| Guardrail | ✅ 输入输出检查 | 过程检查 | 正则 + 关键词过滤 |
| Reflector | ✅ 规则判断 | LLM 反思 | MVP 默认一轮即止 |
| Memory | ✅ SQLite | + 向量数据库 | 会话/消息/文档/用户/用量全部 SQLite |
| 文件存储 | ✅ 本地文件系统 | MinIO | 文档上传到本地 data/uploads 目录 |
| 费用管理 | ✅ CostService | - | 免费额度 + 付费扣费 + 用量统计 |
| 前端 | ✅ 3个页面 | 更多功能 | 智能助手 + 文档管理 + 个人中心 |
| 可观测性 | ✅ 请求/错误日志 | 全链路追踪 | 基础日志输出 |

**MVP 不包含**（后续迭代）：
- 多模态文档解析（图像/公式/表格提取）
- 向量检索（语义搜索）
- Human-In-The-Loop 干预界面
- 个性化推荐与用户画像
- 文档标注、阅读进度
- 全链路追踪

### 5.3 关键里程碑

| 里程碑 | 交付内容 | 验收方式 |
|--------|---------|---------|
| **MVP 发布** | 能完成"检索-筛选-摘要-引用"端到端流程的 Web 应用 | 实际执行一个学术调研任务 |
| **V1.0 发布** | 支持上传论文并就内容多模态问答 | 上传 PDF 并成功就图表/公式提问 |
| **V2.0 发布** | 用户可在关键节点介入修改 Agent 计划 | 完成一次人工干预的完整流程 |

### 5.4 MVP 功能验收

| 模块 | 验收项 |
|------|--------|
| **学术研究助手 Agent** |
| | ✅ 能够完成"检索-筛选-摘要-引用"端到端闭环 |
| | ✅ 任务计划生成合理，步骤清晰（至少 3 步） |
| | ✅ 普通模式下能流式返回回答 |
| | ✅ Agent 模式下能推送计划进度并流式返回摘要 |
| | ✅ 引用格式正确、包含论文标题/作者/年份/会议 |
| **文档管理** |
| | ✅ 支持 PDF、Word、Markdown、Text 格式上传 |
| | ✅ 文件夹创建、删除、文档归类功能正常 |
| | ✅ 文档列表分页正确，页码切换正常 |
| | ✅ 删除文档同时删除服务器文件 |
| **个人中心** |
| | ✅ 个人资料查看/编辑/保存功能正常 |
| | ✅ 模式切换（免费/付费）功能正常 |
| | ✅ 充值功能正常（预设金额 + 自定义金额），充值后余额累加、自动切换付费模式 |
| | ✅ 用量统计面板显示今日对话/免费剩余/费用/累计数据/定价 |
| **模型费用** |
| | ✅ 免费模式每日 20 次对话额度，超出后返回 402 错误并显示提示 |
| | ✅ 付费模式普通对话扣费 ¥0.05/次，Agent 对话扣费 ¥0.20/次 |
| | ✅ 付费模式余额不足时返回 402 错误并显示余额不足提示 |
| | ✅ 每条对话完成后 SSE 流推送 cost 事件，前端显示本次费用和余额 |
| | ✅ 用量记录正确写入，可通过接口分页查询 |
| **通用** |
| | ✅ SSE 流式输出正常（7 种事件类型），无断流 |
| | ✅ 会话历史记录保存并可切换回看 |
| | ✅ 新建对话正确清空状态 |

### 5.5 V1.0 功能验收（在 MVP 基础上新增）

| 模块 | 验收项 |
|------|--------|
| **多模态 RAG** |
| | ✅ 能正确提取 PDF 中的图像、公式、表格 |
| | ✅ 三路召回正常工作，结果多样性良好 |
| | ✅ 检索结果相关性高，Top6 准确率 > 85% |
| | ✅ 回答准确，引用来源可追溯到具体页码 |
| | ✅ 支持多轮对话，上下文理解正确 |
| **检索增强** |
| | ✅ 语义检索功能正常 |
| | ✅ 多源检索结果去重有效 |
| | ✅ 质量校验能发现明显的事实错误 |

### 5.6 V2.0 功能验收（在 V1.0 基础上新增）

| 模块 | 验收项 |
|------|--------|
| **Human-In-The-Loop** |
| | ✅ 用户可查看并修改 Agent 生成的计划 |
| | ✅ 用户可筛选检索结果中要使用的文献 |
| | ✅ 最终结果支持编辑和导出 |
| **个性化推荐** |
| | ✅ 用户画像能反映近期研究兴趣 |
| | ✅ 推荐结果与用户方向相关 |

### 5.7 安全验收

| 指标 | 验收标准 |
|------|----------|
| SQL 注入防护 | 所有数据库操作使用参数化查询 |
| XSS 防护 | 用户输入内容正确转义 |
| 文件上传限制 | 拒绝超过 100MB 的文件，拒绝可执行文件类型 |
| 请求速率限制 | 单用户每分钟不超过 60 次请求 |
| 敏感词过滤 | 拦截已知危险输入模式 |

### 5.8 兼容性验收

| 验收项 | 验收标准 |
|--------|----------|
| 浏览器支持 | Chrome(最新2个版本)、Firefox(最新版本)、Safari(最新版本)、Edge(最新版本) |
| 响应式布局 | 桌面端（≥1024px）正常显示，平板端（≥768px）基本可用 |

---

## 6. 风险控制

### 6.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| LLM 幻觉导致生成内容不准确 | 高 | 高 | 引用溯源机制 + 质量校验 + 明确标注 AI 生成内容 |
| Agent 规划不稳定/死循环 | 高 | 中 | 最大迭代次数限制 + 规则模板兜底 + Human-In-The-Loop 干预 |
| LLM API 成本不可控 | 中 | 高 | 用户配额管理 + 缓存策略 + 模型分层调用（简单问题用小模型） |
| 多模态检索效果不达预期 | 高 | 中 | 先实现文本检索，多模态作为增强项渐进迭代 |
| 外部学术 API 不稳定/限流 | 中 | 高 | 多源 fallback + 本地缓存 + 优雅降级提示 |
| 外部学术数据质量不一致 | 中 | 中 | 去重 + 元数据校验 + 来源可信度评分 |

### 6.2 产品风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 用户需求理解偏差 | 高 | 中 | 快速迭代，收集用户反馈，持续优化 |
| 竞品快速跟进 | 中 | 高 | 聚焦学术场景深度优化，建立技术壁垒 |
| 用户 adoption 低 | 高 | 中 | 提供清晰的价值主张，简化用户操作流程，降低上手门槛 |
| 内容质量不稳定 | 高 | 中 | 多重质量校验 + 人工干预 + 明确告知用户 AI 局限性 |

---

## 附录

### A. 关键术语定义

| 术语 | 解释 |
|------|------|
| RAG | Retrieval Augmented Generation，检索增强生成 |
| Agent | 智能体，能够自主执行任务的软件实体 |
| ReAct | Reasoning + Acting，推理与行动相结合的 Agent 范式 |
| SSE | Server-Sent Events，服务器向客户端推送事件的技术 |
| TODO 范式 | 基于任务列表的执行模式，Agent 按列表逐步执行 |
| Human-In-The-Loop | 人在回路中，在关键节点允许人工介入的系统设计 |
| 三路召回 | 文字-文字 / 文字-图像 / 文字-半结构化信息三路并行检索 |
| TTFT | Time To First Token，首字响应延迟 |

### B. SSE 事件协议

> 适用于 `POST /api/v1/chat/chat` 接口。格式为标准 SSE，每个事件由 `event:` 行和 `data:` 行组成，以 `\n\n` 分隔。

| 事件类型 | 触发模式 | 说明 |
|---------|---------|------|
| `plan` | Agent | 推送研究计划（TODO 列表） |
| `step_start` | Both | 某步骤开始执行 |
| `step_progress` | Agent | 步骤进度更新（含 progress 0.0~1.0） |
| `step_complete` | Both | 某步骤执行完成 |
| `stream` | Both | 流式文本内容片段（前端累加拼接） |
| `done` | Both | 全部完成，携带完整内容 |
