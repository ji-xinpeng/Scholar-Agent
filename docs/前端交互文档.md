# Scholar Agent 前端交互文档

> 版本: v1.2 | 更新日期: 2026-02-16

---

## 1. 全局布局

```
┌──────────────────────────────────────────────────┐
│  顶部导航栏 (Navbar, 高 56px, 固定)              │
├──────────────────────────────────────────────────┤
│                                                  │
│  页面内容区 (flex-1, 充满剩余高度)                │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 1.1 顶部导航栏

| 元素 | 说明 |
|------|------|
| Logo + 品牌名 | 左侧显示图标 + "Scholar Agent"，点击跳转首页 `/` |
| 智能助手 | 导航到 `/`，高亮当前选中 |
| 文档管理 | 导航到 `/`（已集成到首页左侧面板） |

---

## 2. 智能助手页面 (`/`)

### 2.1 页面结构

```
┌──────────────────────────────────────────────────────────────────┐
│ Navbar                                                              │
├────────┬──────────┬──────────┬──────────────────────────────────┤
│        │          │          │                                  │
│ 历史   │ 我的论文 │ 文档内容 │   消息区域 (可滚动)              │
│ 记录   │ 侧边栏   │ 侧边栏   │   - 用户消息 (右侧蓝色气泡)      │
│ 240px  │ 288px    │ 320px    │   - 助手消息 (左侧白色气泡)      │
│        │          │          │   - 任务进度卡片 (Agent模式)     │
│        │          │          │                                  │
│        │          │          ├──────────────────────────────────┤
│        │          │          │ 模式开关 | 联网搜索开关           │
│        │          │          │ [📎附件] [输入框............] [发送➤]    │
└────────┴──────────┴──────────┴──────────────────────────────────┘
```

### 2.2 左侧历史记录侧边栏

| 交互 | 行为 |
|------|------|
| 点击「新建对话」按钮 | 清空当前消息和会话ID，输入框获取焦点 |
| 点击某条历史记录 | 调用 `GET /chat/sessions/{id}/messages` 加载该会话消息 |
| 点击历史记录的删除图标 | 调用 `DELETE /chat/sessions/{id}` 删除该会话；若删除的是当前会话则触发新建对话 |
| 数据加载时机 | 每次 `sessionId` 变化时重新调用 `GET /chat/sessions` 刷新列表 |

### 2.3 论文管理侧边栏 (我的论文)

| 交互 | 行为 |
|------|------|
| 点击「全部论文」 | `selectedFolder = null`，加载所有文档，页码重置为 1 |
| 点击某个文件夹 | `selectedFolder = folder.id`，加载该文件夹文档，页码重置为 1 |
| 点击文件夹右侧删除图标 | 调用 `DELETE /documents/folders/{id}`；该文件夹下的文档 folder_id 置为 null |
| 点击 ➕ 新建文件夹 | 展开输入框，回车或点击"添加"后调用 `POST /documents/folders` |
| 每个文件夹右侧 | 显示该文件夹的文档数量（`document_count`） |
| 拖拽论文到聊天区域 | 将论文ID添加到选中文档列表，在输入框显示文档名称 |
| 点击文档列表项 | 在文档内容侧边栏显示文档内容 |
| 搜索文档 | 客户端过滤，基于 `original_name` 模糊匹配 |

### 2.4 文档内容侧边栏

| 交互 | 行为 |
|------|------|
| 点击文档 | 调用 `GET /api/v1/documents/{doc_id}/content` 获取文档内容 |
| 可编辑文档 (word/markdown/text) | 显示文本编辑器，支持修改 |
| 点击「保存」 | 调用 `PUT /api/v1/documents/{doc_id}/content` 更新文档内容 |
| 文档更新事件 | 收到 `doc_updated` SSE事件时自动刷新文档内容 |
| 点击关闭按钮 | 关闭文档内容侧边栏 |

### 2.5 空状态（无消息时）

居中显示：
- Scholar Agent 图标 + 标题
- 副标题："AI驱动的智能学术研究助手..."
- 4 个快捷问题按钮（2×2 网格），点击后填入输入框并聚焦

### 2.6 模式与功能开关

| 开关 | 状态 | 说明 |
|------|------|------|
| 模式切换 | `normal` / `agent` | 点击切换，`agent` 时高亮紫色，输入框占位符变为"描述你的研究任务..." |
| 联网搜索 | `true` / `false` | 点击切换，开启时高亮绿色 |

### 2.7 文件上传

| 交互 | 行为 |
|------|------|
| 点击附件按钮 | 弹出文件选择器（支持多选），接受 `.pdf,.doc,.docx,.md,.txt,.png,.jpg,.jpeg,.gif` |
| 选择图片后 | 在输入框上方显示缩略图预览，右上角显示红色×删除按钮 |
| 选择文档后 | 上传到后端，添加到选中文档列表 |
| 点击×删除 | 移除预览和选中状态 |
| 发送时 | 附件已上传的文档ID会被发送给后端 |

### 2.8 消息发送流程

```
用户点击发送 / 按 Enter（非 Shift+Enter）
    │
    ├─ 前置校验：文字或附件至少有一项，且不在 loading 状态
    │
    ├─ 立即添加用户消息到 messages 列表（乐观更新）
    ├─ 清空输入框、图片预览、附件列表
    ├─ 设置 isLoading = true
    │
    ├─ 调用 POST /chat/chat (SSE 流，直接访问后端地址)
    │   ├─ 请求体: { message, session_id, user_id, mode, web_search, document_ids }
    │   ├─ 响应头 X-Session-Id: 返回会话ID（首次对话时用此更新 sessionId）
    │   │
    │   ├─ SSE 事件处理：
    │   │   ├─ event: plan      → 渲染任务进度卡片（Agent模式）
    │   │   ├─ event: step_start    → 对应步骤状态变为 "running"
    │   │   ├─ event: step_progress → 更新进度条和提示文字
    │   │   ├─ event: step_complete → 对应步骤状态变为 "done"
    │   │   ├─ event: stream    → 累加内容到 streamingContent，实时渲染
    │   │   ├─ event: doc_updated → 刷新对应文档内容
    │   │   └─ event: done      → 标记完成
    │   │
    │   └─ 流结束（onDone）
    │       ├─ 将累积内容添加为 assistant 消息
    │       ├─ 清空 streamingContent
    │       └─ 设置 isLoading = false
    │
    └─ 若首次对话，用返回的 session_id 更新状态
```

### 2.9 消息气泡渲染

| 角色 | 样式 | 内容渲染 |
|------|------|---------|
| 用户 | 右侧，蓝色背景白色文字，右上角小圆角 | 纯文本 + 可选图片 |
| 助手 | 左侧，白色背景灰色文字，左上角小圆角 | 支持 Markdown：`**粗体**`、`## 标题`、`- 列表项`、换行 |
| 助手（加载中） | 左侧，三个跳动的灰色圆点 | 无文字时显示 |

### 2.10 任务进度卡片（Agent 模式）

显示在消息流中，白色卡片带边框：
- 标题："研究计划"
- Agent思考（thought）：显示在顶部
- 每个步骤一行：
  - ⭕ 灰色空心圆 = pending
  - 🔄 旋转的蓝色加载图标 = running（附带进度条和提示文字）
  - ✅ 绿色对勾 = done（文字加删除线，显示步骤总结）

---

## 3. 文档管理（已集成到首页）

### 3.1 论文管理侧边栏结构

```
┌──────────────────┐
│ 我的论文         │ [+新建文件夹]
├──────────────────┤
│ [🔍 搜索文档...]  │
├──────────────────┤
│ 📁 全部论文      │
│ 📁 文件夹1 (3)   │ [🗑]
│ 📁 文件夹2 (7)   │ [🗑]
├──────────────────┤
│  拖拽上传区域     │
├──────────────────┤
│  文档列表        │
│  ┌─────────────┐ │
│  │ 📄 文件名   │ │ [🗑]
│  └─────────────┘ │
│  分页: [◀][1][2][▶]│
└──────────────────┘
```

### 3.2 上传区域

| 交互 | 行为 |
|------|------|
| 点击上传区域 | 弹出文件选择器（支持多选），接受 `.pdf,.doc,.docx,.md,.txt` |
| 拖拽文件到上传区域 | 触发上传 |
| 上传过程中 | 图标变为蓝色弹跳动画，文字显示"上传中..." |
| 上传完成 | 自动刷新文档列表和文件夹列表 |
| 上传限制 | 单文件最大 100MB；空文件拒绝 |

### 3.3 文档内容查看与编辑

| 交互 | 行为 |
|------|------|
| 点击文档列表项 | 打开文档内容侧边栏，加载并显示文档内容 |
| PDF文档 | 显示解析后的文本内容（只读） |
| Word/Markdown/Text文档 | 显示可编辑的文本框 |
| 修改内容 | 编辑器内容变化时标记为"未保存" |
| 点击保存 | 调用API保存内容，显示"保存中..." |
| Agent模式编辑 | Agent使用DocEditTool修改文档时，会触发doc_updated事件自动刷新 |

---

## 4. 通用交互规范

### 4.1 加载状态

| 场景 | 表现 |
|------|------|
| 聊天等待回复 | 显示跳动圆点动画 |
| 文件上传中 | 上传图标弹跳 + 文字"上传中..." |
| 文档内容加载 | 显示旋转加载动画 |
| 文档保存中 | 按钮文字变为"保存中..."，按钮禁用 |

### 4.2 提示信息 (Toast)

- 固定在页面顶部居中
- 绿色背景白色文字
- 自动 3 秒后消失
- 淡入动画

### 4.3 消息自动滚动

- 新消息、流式内容更新、任务步骤变化时，自动滚动到底部
- 使用 `scrollIntoView({ behavior: "smooth" })`

### 4.4 键盘快捷键

| 快捷键 | 页面 | 行为 |
|--------|------|------|
| Enter | 聊天页 | 发送消息 |
| Shift + Enter | 聊天页 | 换行（不发送） |
| Enter | 新建文件夹 | 确认创建 |
