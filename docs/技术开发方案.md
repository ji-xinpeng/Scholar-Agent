# Scholar Agent æŠ€æœ¯å¼€å‘æ–¹æ¡ˆ

> ç‰ˆæœ¬: v1.2 | æ›´æ–°æ—¥æœŸ: 2026-02-16
>
> å…³è”æ–‡æ¡£: [PRD](./äº§å“éœ€æ±‚æ–‡æ¡£.md) Â· [API æ¥å£æ–‡æ¡£](./APIæ¥å£æ–‡æ¡£.md) Â· [å‰ç«¯äº¤äº’æ–‡æ¡£](./å‰ç«¯äº¤äº’æ–‡æ¡£.md)

---

## ç›®å½•

1. [é¡¹ç›®æ€»è§ˆ](#1-é¡¹ç›®æ€»è§ˆ)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [åç«¯è¯¦ç»†è®¾è®¡](#3-åç«¯è¯¦ç»†è®¾è®¡)
4. [å‰ç«¯è¯¦ç»†è®¾è®¡](#4-å‰ç«¯è¯¦ç»†è®¾è®¡)
5. [æ•°æ®åº“è®¾è®¡](#5-æ•°æ®åº“è®¾è®¡)
6. [Agent æ ¸å¿ƒæµç¨‹](#6-agent-æ ¸å¿ƒæµç¨‹)
7. [SSE æµå¼åè®®](#7-sse-æµå¼åè®®)
8. [å¼€å‘è§„èŒƒ](#8-å¼€å‘è§„èŒƒ)

---

## 1. é¡¹ç›®æ€»è§ˆ

### 1.1 é¡¹ç›®ä¿¡æ¯

| å±æ€§ | å†…å®¹ |
|------|------|
| é¡¹ç›®åç§° | Scholar Agentï¼ˆæ™ºèƒ½å­¦æœ¯åŠ©æ‰‹ï¼‰ |
| åç«¯æ¡†æ¶ | Python 3.10+ / FastAPI |
| å‰ç«¯æ¡†æ¶ | Next.js 14 / TypeScript / Tailwind CSS |
| Agent ç¼–æ’ | è‡ªç ” Agent æµç¨‹ |
| LLM æ¥å…¥ | æ”¯æŒ DeepSeek ã€åƒé—®ç­‰ä¸åŒçš„æ¨¡å‹æ¥å…¥ |
| æ•°æ®å­˜å‚¨ | SQLite |
| æ–‡ä»¶å­˜å‚¨ | æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ |

### 1.2 ä»£ç ä»“åº“ç»“æ„

```
Scholar Agent/
â”œâ”€â”€ backend/                     # åç«¯ Python æœåŠ¡
â”‚   â”œâ”€â”€ server.py               # FastAPI å…¥å£
â”‚   â”œâ”€â”€ requirements.txt         # Python ä¾èµ–
â”‚   â””â”€â”€ app/
â”‚       â”œâ”€â”€ core/                # æ ¸å¿ƒé…ç½®ä¸åŸºç¡€è®¾æ–½
â”‚       â”‚   â”œâ”€â”€ config.py        #   ç¯å¢ƒé…ç½®ï¼ˆSettingsï¼‰
â”‚       â”‚   â”œâ”€â”€ database.py      #   SQLite è¿æ¥ä¸å»ºè¡¨
â”‚       â”‚   â””â”€â”€ logger.py        #   æ—¥å¿—é…ç½®
â”‚       â”œâ”€â”€ models/
â”‚       â”‚   â””â”€â”€ schemas.py       #   Pydantic è¯·æ±‚/å“åº”æ¨¡å‹
â”‚       â”œâ”€â”€ domain/              # é¢†åŸŸå±‚
â”‚       â”‚   â””â”€â”€ llm_scheduler/ # LLM è°ƒåº¦å™¨
â”‚       â”‚       â”œâ”€â”€ base.py       #   åŸºç±»
â”‚       â”‚       â”œâ”€â”€ factory.py      #   å·¥å‚
â”‚       â”‚       â”œâ”€â”€ service.py       #   æœåŠ¡
â”‚       â”‚       â””â”€â”€ models/         #   æ¨¡å‹å®ç°
â”‚       â”‚           â”œâ”€â”€ deepseek.py    #     DeepSeek
â”‚       â”‚           â””â”€â”€ qwen.py       #     é€šä¹‰åƒé—®
â”‚       â”œâ”€â”€ tools/               # å·¥å…·å±‚
â”‚       â”‚   â”œâ”€â”€ toolhub.py       #   å·¥å…·æ³¨å†Œä¸­å¿ƒ
â”‚       â”‚   â””â”€â”€ src/             #   å·¥å…·å®ç°
â”‚       â”‚       â”œâ”€â”€ search.py       #     æœç´¢å·¥å…·
â”‚       â”‚       â””â”€â”€ multimodal_parse.py # å¤šæ¨¡æ€è§£æå·¥å…·
â”‚       â”œâ”€â”€ services/            # ä¸šåŠ¡æœåŠ¡å±‚
â”‚       â”‚   â”œâ”€â”€ agent_service.py #   Agent è¿è¡Œ + SSE æµç”Ÿæˆ
â”‚       â”‚   â”œâ”€â”€ document_service.py  # æ–‡æ¡£/æ–‡ä»¶å¤¹ CRUD + å†…å®¹ç¼–è¾‘
â”‚       â”‚   â””â”€â”€ user_service.py  #   ç”¨æˆ·èµ„æ–™
â”‚       â””â”€â”€ api/api_v1/          # API è·¯ç”±å±‚
â”‚           â”œâ”€â”€ api.py           #   è·¯ç”±èšåˆ
â”‚           â””â”€â”€ endpoints/
â”‚               â”œâ”€â”€ chat.py      #   èŠå¤©ç›¸å…³æ¥å£
â”‚               â”œâ”€â”€ documents.py #   æ–‡æ¡£ç›¸å…³æ¥å£
â”‚               â””â”€â”€ users.py     #   ç”¨æˆ·ç›¸å…³æ¥å£
â”œâ”€â”€ frontend/                    # å‰ç«¯ Next.js åº”ç”¨
â”‚   â”œâ”€â”€ app/                     # App Router é¡µé¢
â”‚   â”‚   â”œâ”€â”€ page.tsx             #   æ™ºèƒ½åŠ©æ‰‹ï¼ˆä¸»é¡µï¼ŒåŒ…å«æ–‡æ¡£ç®¡ç†å’ŒèŠå¤©ï¼‰
â”‚   â”‚   â”œâ”€â”€ profile/page.tsx     #   ä¸ªäººä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ layout.tsx           #   æ ¹å¸ƒå±€
â”‚   â”‚   â””â”€â”€ globals.css        #   å…¨å±€æ ·å¼
â”‚   â”œâ”€â”€ components/              # å…±äº«ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Navbar.tsx           #   é¡¶éƒ¨å¯¼èˆªæ 
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx          #   èŠå¤©å†å²ä¾§è¾¹æ 
â”‚   â”‚   â”œâ”€â”€ ChatMessage.tsx      #   æ¶ˆæ¯æ°”æ³¡
â”‚   â”‚   â””â”€â”€ TaskProgress.tsx     #   ä»»åŠ¡è¿›åº¦å¡ç‰‡
â”‚   â””â”€â”€ lib/                     # å·¥å…·åº“
â”‚       â”œâ”€â”€ api.ts               #   åç«¯ API å®¢æˆ·ç«¯
â”‚       â””â”€â”€ utils.ts             #   é€šç”¨å·¥å…·å‡½æ•°
â””â”€â”€ docs/                        # é¡¹ç›®æ–‡æ¡£
    â”œâ”€â”€ æŠ€æœ¯å¼€å‘æ–¹æ¡ˆ.md            #   æœ¬æ–‡æ¡£
    â”œâ”€â”€ APIæ¥å£æ–‡æ¡£.md            #   æ¥å£è§„èŒƒ
    â”œâ”€â”€ äº§å“éœ€æ±‚æ–‡æ¡£.md          #   äº§å“éœ€æ±‚
    â””â”€â”€ å‰ç«¯äº¤äº’æ–‡æ¡£.md           #   äº¤äº’è§„èŒƒ
```

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 ç³»ç»Ÿåˆ†å±‚æ¶æ„å›¾ï¼ˆæ€»è§ˆï¼‰

![image-20260218131657343](assets/image-20260218131657343.png)

### 2.2 æ¶æ„å›¾è¯¦ç»†è¯´æ˜

ç³»ç»Ÿæ¶æ„åˆ†ä¸ºå››å±‚ï¼šæ¥å…¥å±‚ã€åº”ç”¨å±‚ã€å·¥å…·å±‚ã€åŸºå»ºå±‚ã€‚

---

#### 2.2.1 æ¥å…¥å±‚

| ç»„ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **Web å‰ç«¯** | Next.js é¡µé¢ï¼Œlib/api.ts è°ƒç”¨åç«¯ | âœ… å·²æœ‰ |
| **RESTful API** | FastAPI è·¯ç”±ï¼ŒHTTP/SSE åè®® | âœ… å·²æœ‰ |
| **SDK** | ç¬¬ä¸‰æ–¹é›†æˆç”¨ SDK | ğŸ“… è§„åˆ’ä¸­ |
| **ç§»åŠ¨ç«¯ APP** | åŸç”Ÿç§»åŠ¨åº”ç”¨ | ğŸ“… è§„åˆ’ä¸­ |

---

#### 2.2.2 åº”ç”¨å±‚ï¼ˆAgent Applicationï¼‰

| æ¨¡å— | èŒè´£ | è¯´æ˜ |
|------|------|------|
| **ä»»åŠ¡è§„åˆ’** | å°†ç”¨æˆ·å¤æ‚ç›®æ ‡æ‹†åˆ†ä¸ºå¯æ‰§è¡Œ TODO åˆ—è¡¨ | âœ… Agent Service |
| **å·¥å…·è°ƒç”¨** | åè°ƒè°ƒç”¨å„å·¥å…·å®Œæˆä»»åŠ¡ | âœ… Agent Service |
| **ä¼šè¯ç®¡ç†** | ä¸Šä¸‹æ–‡å‹ç¼©ã€ä¼šè¯ CRUD | âœ… SessionService |
| **RAG é—®ç­”** | åŸºäºå¤šæ¨¡æ€çš„é—®ç­”èƒ½åŠ› | ğŸ“… V1.0 |
| **äººå·¥å¹²é¢„** | å…³é”®èŠ‚ç‚¹æ”¯æŒäººå·¥ç¡®è®¤å’Œä¿®æ”¹ | ğŸ“… V2.0 |
| **æ™ºèƒ½è·¯ç”±** | æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æœ€ä¼˜å¤„ç†è·¯å¾„ | ğŸ“… V2.0 |
| **ç”¨æˆ·ç®¡ç†** | ç”¨æˆ·èµ„æ–™ã€ç”¨æˆ·ç”»åƒ | âœ… UserService |
| **æ–‡æ¡£ç®¡ç†** | æ–‡ä»¶ç®¡ç†ã€çŸ¥è¯†åº“æ„å»º | âœ… DocumentService |

---

#### 2.2.3 å·¥å…·å±‚

| å·¥å…·åˆ†ç±» | å·¥å…· | è¯´æ˜ |
|---------|------|------|
| **Document å·¥å…·** | å¤šæ¨¡æ€è§£æ | PDF/Word/å›¾ç‰‡ç­‰æ–‡æ¡£è§£æ |
| | æ–‡æ¡£ç¼–è¾‘ | åœ¨çº¿ç¼–è¾‘æ–‡æ¡£å†…å®¹ |
| | çŸ¥è¯†åº“æ„å»º | æ–‡æ¡£ç´¢å¼•ä¸çŸ¥è¯†åº“å»ºç«‹ |
| **æ£€ç´¢å·¥å…·** | è”ç½‘æ£€ç´¢ | arXivã€å­¦æœ¯æœç´¢å¼•æ“ç­‰ |
| | æœ¬åœ°æ£€ç´¢ | æœ¬åœ°æ–‡æ¡£åº“æ£€ç´¢ |
| | ç­›é€‰æ’åº | ç»“æœç­›é€‰ä¸æ’åº |
| **ä¼šè¯å·¥å…·** | ä¼šè¯ CRUD | ä¼šè¯åˆ›å»ºã€æŸ¥è¯¢ã€åˆ é™¤ |
| | ä¸Šä¸‹æ–‡å‹ç¼© | å¯¹è¯ä¸Šä¸‹æ–‡å‹ç¼© |
| | è®°å¿† | é•¿æœŸè®°å¿†ç®¡ç† |
| **å†…å®¹å¤„ç†å·¥å…·** | å½’çº³æ€»ç»“ | æ–‡çŒ®å½’çº³æ€»ç»“ |
| | å¼•ç”¨ç”Ÿæˆ | è‡ªåŠ¨ç”Ÿæˆå¼•ç”¨æ ¼å¼ |
| **ç”¨æˆ·å·¥å…·** | ç”¨æˆ·ç”»åƒ | æ„å»ºç”¨æˆ·ç ”ç©¶å…´è¶£ç”»åƒ |
| | ä¸ªæ€§åŒ– | ä¸ªæ€§åŒ–æ¨èä¸å†…å®¹é€‚é… |

---

#### 2.2.4 åŸºå»ºå±‚

##### åŸºç¡€è®¾æ–½

| ç»„ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **å¤–éƒ¨å­¦æœ¯èµ„æºåº“** | arXivã€å­¦æœ¯æœç´¢å¼•æ“ç­‰å¤–éƒ¨ API | âœ… å·²æœ‰ |
| **å¤§æ¨¡å‹è°ƒåº¦** | LLM è°ƒç”¨ï¼ˆDeepSeekã€åƒé—®ç­‰ï¼‰ | âœ… å·²æœ‰ |
| **å®‰å…¨å®¡æ ¸** | å†…å®¹å®‰å…¨ã€è¾“å…¥è¾“å‡ºå®¡æ ¸ | ğŸ“… è§„åˆ’ä¸­ |
| **æ—¥å¿—ç³»ç»Ÿ** | åº”ç”¨æ—¥å¿—ã€é”™è¯¯æ—¥å¿— | âœ… å·²æœ‰ |
| **å¼‚æ­¥å¤„ç†** | å¼‚æ­¥ä»»åŠ¡å¤„ç† | ğŸ“… è§„åˆ’ä¸­ |

##### æ•°æ®å­˜å‚¨

| ç»„ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **SQLite** | å…³ç³»å‹å­˜å‚¨ï¼ˆä¼šè¯ã€æ¶ˆæ¯ã€æ–‡æ¡£ã€ç”¨æˆ·ç­‰ï¼‰ | âœ… å½“å‰ |
| **Redis** | ç¼“å­˜ã€ä¼šè¯ã€å¼‚æ­¥é˜Ÿåˆ— | ğŸ“… è§„åˆ’ä¸­ |
| **æ–‡ä»¶ç³»ç»Ÿ** | ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ | âœ… å·²æœ‰ |
| **Milvus** | å‘é‡æ£€ç´¢æ•°æ®åº“ | ğŸ“… V1.0 |

### 2.3 å±‚é—´è¯·æ±‚æµè½¬è¯´æ˜

```mermaid
flowchart LR
    subgraph è¯·æ±‚è¿›å…¥
        R1[HTTP/SSE è¯·æ±‚]
    end
    subgraph L2["æ¥å…¥å±‚"]
        R2[Web å‰ç«¯]
        R3[RESTful API]
        R2 --> R3
    end
    subgraph L3["åº”ç”¨å±‚"]
        R4[Agent Application]
        R5[æœåŠ¡è°ƒç”¨]
        R4 --> R5
    end
    subgraph L4["å·¥å…·å±‚"]
        R6[å„å·¥å…·æ¨¡å—]
    end
    subgraph L5["åŸºå»ºå±‚"]
        R7[(æ•°æ®å­˜å‚¨)]
        R8[å¤§æ¨¡å‹/å¤–éƒ¨API]
        R7 & R8 --> R9[ç»“æœ]
    end
    R1 --> R2
    R3 --> R4
    R5 --> R6
    R6 --> R7 & R8
    R9 --> R4
    R4 --> R10[å“åº”/Stream]
    R10 --> R1
```

### 2.2 ç³»ç»Ÿæ•°æ®æµå›¾ï¼ˆè¯·æ±‚-å“åº”è·¯å¾„ï¼‰

```mermaid
flowchart LR
    subgraph ç”¨æˆ·ç«¯
        A[ç”¨æˆ·æ“ä½œ]
    end

    subgraph å‰ç«¯
        B[Next.js é¡µé¢]
        C[lib/api.ts]
        B --> C
    end

    subgraph åç«¯
        D[FastAPI Router]
        E[Service å±‚]
        F[DB / æ–‡ä»¶ / å¤–éƒ¨ API]
        D --> E
        E --> F
    end

    A -->|"ç‚¹å‡»/è¾“å…¥"| B
    C -->|"fetch / SSE (ç›´è¿åç«¯"| D
    F -->|"ç»“æœ"| E
    E -->|"å“åº”"| D
    D -->|"JSON / Stream"| C
    C -->|"æ›´æ–° state"| B
    B -->|"æ¸²æŸ“"| A
```

### 2.3 èŠå¤©è¯·æ±‚å®Œæ•´æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant FE as å‰ç«¯ (Next.js)
    participant API as FastAPI è·¯ç”±å±‚
    participant Chat as ChatService (SessionService)
    participant Agent as AgentService
    participant LLM as LLM Scheduler
    participant DB as SQLite
    participant FE as å‰ç«¯

    User->>FE: è¾“å…¥æ¶ˆæ¯ + ç‚¹å‡»å‘é€
    FE->>FE: ä¹è§‚æ›´æ–° UIï¼ˆæ·»åŠ ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡ï¼‰

    FE->>API: POST /api/v1/chat/chat {message, mode, session_id, document_ids}

    API->>Chat: create_session / get_session
    API->>Chat: add_message(user)
    Chat->>DB: INSERT æ¶ˆæ¯

    alt mode = normal
        API->>Agent: run_normal_chat()
    else mode = agent
        API->>Agent: run_agent_chat()
    end

    API-->>FE: StreamingResponse (SSE)

    loop SSE äº‹ä»¶æµ
        Agent-->>FE: event: plan / thought / step_start / step_progress / step_complete
        Agent-->>FE: event: stream {content}
        Agent-->>FE: event: doc_updated {doc_id} (å¯é€‰
        FE->>FE: å®æ—¶æ›´æ–°æ¶ˆæ¯ + ä»»åŠ¡å¡ç‰‡ + æ–‡æ¡£å†…å®¹
    end

    Agent->>Chat: add_message(assistant)
    Chat->>DB: INSERT åŠ©æ‰‹æ¶ˆæ¯
    API-->>FE: event: done {content}

    FE->>FE: å®Œæˆæ¶ˆæ¯æ¸²æŸ“
```

### 2.4 æ¨¡å—ä¾èµ–å…³ç³»å›¾

```mermaid
graph LR
    subgraph API["API è·¯ç”±å±‚"]
        chat_ep["chat.py"]
        doc_ep["documents.py"]
        user_ep["users.py"]
    end

    subgraph Services["ä¸šåŠ¡æœåŠ¡å±‚"]
        agent_svc["AgentService"]
        doc_svc["DocumentService"]
        user_svc["UserService"]
    end

    subgraph Domain["é¢†åŸŸå±‚"]
        llm_scheduler["LLM Scheduler"]
    end

    subgraph Tools["å·¥å…·å±‚"]
        toolhub["ToolHub"]
    end

    subgraph Infra["åŸºç¡€è®¾æ–½"]
        db[("SQLite")]
        fs[("æ–‡ä»¶ç³»ç»Ÿ")]
        llm["OpenAI SDK"]
    end

    chat_ep --> agent_svc
    doc_ep --> doc_svc
    user_ep --> user_svc

    agent_svc --> llm_scheduler
    agent_svc --> toolhub
    agent_svc --> doc_svc

    llm_scheduler --> llm

    agent_svc & doc_svc & user_svc --> db
    doc_svc --> fs
```

### 2.5 æ–‡æ¡£ä¸Šä¼ ä¸ç¼–è¾‘æµç¨‹å›¾

```mermaid
flowchart TD
    A[ç”¨æˆ·é€‰æ‹©/æ‹–æ‹½æ–‡ä»¶] --> B[å‰ç«¯ FormData]
    B --> C[POST /api/v1/documents/upload]
    C --> D[API æ ¡éªŒ Content-Type]
    D --> E{ç±»å‹åˆæ³•?}
    E -->|å¦| F[400 Bad Request]
    E -->|æ˜¯| G[DocumentService.upload_document]
    G --> H[ç”Ÿæˆ UUID æ–‡ä»¶å]
    H --> I[å†™å…¥ data/uploads]
    I --> J[INSERT documents è¡¨]
    J --> K[è¿”å› document å¯¹è±¡]
    K --> L[å‰ç«¯åˆ·æ–°åˆ—è¡¨/æç¤ºæˆåŠŸ]
    L --> M[ç‚¹å‡»æ–‡æ¡£æŸ¥çœ‹å†…å®¹]
    M --> N{æ–‡æ¡£ç±»å‹?}
    N -->|PDF| O[è§£æå¹¶æ˜¾ç¤ºæ–‡æœ¬åªè¯»]
    N -->|Word/Markdown/Text| P[æ˜¾ç¤ºå¯ç¼–è¾‘æ–‡æœ¬æ¡†]
    P --> Q[ç”¨æˆ·ä¿®æ”¹å†…å®¹]
    Q --> S[æ›´æ–°æ–‡ä»¶å†…å®¹]
    S --> T[å‰ç«¯åˆ·æ–°æ˜¾ç¤º]
```

---

## 3. åç«¯è¯¦ç»†è®¾è®¡

### 3.1 æ ¸å¿ƒé…ç½® (`app/core/config.py`)

é€šè¿‡ç¯å¢ƒå˜é‡æˆ– `.env` æ–‡ä»¶é…ç½®ï¼Œç”± Pydantic Settings è‡ªåŠ¨åŠ è½½ã€‚

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `DATABASE_PATH` | `data/scholar_agent.db` | SQLite æ•°æ®åº“è·¯å¾„ |
| `UPLOAD_DIR` | `data/uploads` | ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½• |
| `OPENAI_API_KEY` | `""` | OpenAI API å¯†é’¥ |
| `OPENAI_BASE_URL` | `""` | è‡ªå®šä¹‰ API åœ°å€ï¼ˆå…¼å®¹ DeepSeek ç­‰ï¼‰ |
| `OPENAI_MODEL` | `deepseek-chat` | é»˜è®¤æ¨¡å‹ |
| `BACKEND_PORT` | `8088` | åç«¯æœåŠ¡ç«¯å£ |

**ç¯å¢ƒå˜é‡ç¤ºä¾‹ (`.env`)**:
```env
OPENAI_API_KEY=sk-xxxx
OPENAI_BASE_URL=https://api.deepseek.com/v1
OPENAI_MODEL=deepseek-chat
```

### 3.2 æ•°æ®åº“å±‚ (`app/core/database.py`)

- ä½¿ç”¨å…¨å±€å•ä¾‹è¿æ¥ï¼Œ`check_same_thread=False` æ”¯æŒå¤šçº¿ç¨‹
- å¯ç”¨ WAL æ¨¡å¼ï¼ˆWrite-Ahead Loggingï¼‰æå‡å¹¶å‘è¯»æ€§èƒ½
- å¯ç”¨å¤–é”®çº¦æŸ
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å»ºè¡¨ï¼ˆ`CREATE TABLE IF NOT EXISTS`ï¼‰

### 3.3 ä¸šåŠ¡æœåŠ¡å±‚

#### 3.3.1 SessionService (`app/services/agent_service.py` å†…ï¼‰

| æ–¹æ³• | åŠŸèƒ½ | ç‰¹æ®Šé€»è¾‘ |
|------|------|---------|
| `create_session()` | åˆ›å»ºæ–°ä¼šè¯ | è¿”å›åŒ…å« UUID çš„ä¼šè¯å¯¹è±¡ |
| `get_session()` | è·å–ä¼šè¯ | è¿”å› None å¦‚æœä¸å­˜åœ¨ |
| `list_sessions()` | åˆ—å‡ºç”¨æˆ·æ‰€æœ‰ä¼šè¯ | æŒ‰ updated_at DESC æ’åº |
| `delete_session()` | åˆ é™¤ä¼šè¯ | çº§è”åˆ é™¤å…³è”æ¶ˆæ¯ |
| `add_message()` | æ·»åŠ æ¶ˆæ¯ | é¦–æ¡ user æ¶ˆæ¯è‡ªåŠ¨æ›´æ–°ä¼šè¯æ ‡é¢˜ï¼ˆå–å‰ 50 å­—ï¼‰ |
| `get_messages()` | è·å–ä¼šè¯æ¶ˆæ¯ | æŒ‰ created_at ASC æ’åºï¼Œè‡ªåŠ¨è§£æ metadata_json |

#### 3.3.2 DocumentService (`app/services/document_service.py`)

| æ–¹æ³• | åŠŸèƒ½ | ç‰¹æ®Šé€»è¾‘ |
|------|------|---------|
| `upload_document()` | ä¸Šä¼ æ–‡æ¡£ | æ–‡ä»¶ä¿å­˜åˆ° `UPLOAD_DIR/{uuid}.ext`ï¼Œæ‰©å±•åæ˜ å°„ file_type |
| `list_documents()` | åˆ†é¡µæŸ¥è¯¢æ–‡æ¡£ | æ”¯æŒæŒ‰ folder_id ç­›é€‰ |
| `get_document()` | è·å–æ–‡æ¡£è¯¦æƒ… | |
| `delete_document()` | åˆ é™¤æ–‡æ¡£ | åŒæ—¶åˆ é™¤ç‰©ç†æ–‡ä»¶ |
| `move_document()` | ç§»åŠ¨æ–‡æ¡£åˆ°æ–‡ä»¶å¤¹ | æ›´æ–° folder_id |
| `create_folder()` | åˆ›å»ºæ–‡ä»¶å¤¹ | æ”¯æŒ parent_id åµŒå¥— |
| `list_folders()` | åˆ—å‡ºæ–‡ä»¶å¤¹ | åŠ¨æ€è®¡ç®—æ¯ä¸ªæ–‡ä»¶å¤¹çš„ document_count |
| `delete_folder()` | åˆ é™¤æ–‡ä»¶å¤¹ | æ–‡ä»¶å¤¹å†…æ–‡æ¡£çš„ folder_id ç½®ä¸º NULLï¼ˆæ–‡æ¡£ä¸åˆ é™¤ï¼‰ |
| `get_document_content()` | è·å–æ–‡æ¡£å†…å®¹ | æ”¯æŒ PDF/Word/Markdown/Text è§£æ |
| `update_document_content()` | æ›´æ–°æ–‡æ¡£å†…å®¹ | æ”¯æŒ Word/Markdown/Text æ ¼å¼å†™å…¥ |
| `append_document_content()` | è¿½åŠ æ–‡æ¡£å†…å®¹ | |
| `replace_document_content()` | æ›¿æ¢æ–‡æ¡£å†…å®¹ | |

#### 3.3.3 UserService (`app/services/user_service.py`)

| æ–¹æ³• | åŠŸèƒ½ | ç‰¹æ®Šé€»è¾‘ |
|------|------|---------|
| `get_profile()` | è·å–ç”¨æˆ·èµ„æ–™ | ç”¨æˆ·ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé»˜è®¤èµ„æ–™ |
| `update_profile()` | æ›´æ–°èµ„æ–™ | åªæ›´æ–°é null å­—æ®µ |

#### 3.3.4 AgentService (`app/services/agent_service.py`)

**æ ¸å¿ƒèŒè´£**ï¼šæ¥æ”¶ç”¨æˆ·æ¶ˆæ¯ï¼Œé©±åŠ¨ Agent æµç¨‹ï¼Œç”Ÿæˆ SSE äº‹ä»¶æµã€‚

| å‡½æ•° | æ¨¡å¼ | æµç¨‹ |
|------|------|------|
| `run_normal_chat()` | æ™®é€šæ¨¡å¼ | streamï¼ˆåˆ†å—ï¼‰â†’ done |
| `run_agent_chat()` | æ™ºèƒ½ä½“æ¨¡å¼ | planï¼ˆå« thoughtï¼‰ â†’ [step_startâ†’progressâ†’completeï¼ˆå« thought_summaryï¼‰] Ã— N â†’ stream â†’ done |

**SSE äº‹ä»¶ç”Ÿæˆ**:
```python
def _sse(self, event_type: str, data: dict) -> str:
    data["timestamp"] = datetime.now(timezone.utc).isoformat()
    return f"event: {event_type}\ndata: {json.dumps(data, ensure_ascii=False)}\n\n"
```

**Agent æ¨¡å¼ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ LLM åŠ¨æ€ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼ˆåŒ…å« thought å­—æ®µï¼‰
- æ”¯æŒåŠ¨æ€æ­¥éª¤
- æ”¯æŒæ–‡æ¡£ç¼–è¾‘ï¼ˆDocEditToolï¼‰
- æ–‡æ¡£ç¼–è¾‘åå‘é€ doc_updated äº‹ä»¶

#### 3.3.5 LLMScheduler (`app/domain/llm_scheduler/`)

**æ ¸å¿ƒèŒè´£**ï¼šç»Ÿä¸€çš„ LLM è°ƒç”¨æ¥å£ï¼Œæ”¯æŒå¤šæä¾›å•†

| æä¾›å•† | æ–‡ä»¶ | è¯´æ˜ |
|--------|------|------|
| DeepSeek | `models/deepseek.py` | DeepSeek æ¨¡å‹é›†æˆ |
| é€šä¹‰åƒé—® | `models/qwen.py` | é€šä¹‰åƒé—®æ¨¡å‹é›†æˆ |

**æœåŠ¡æ–¹æ³•**ï¼š
- `chat()`: éæµå¼è¿”å›
- `chat_stream()`: æµå¼å¯¹è¯

### 3.4 ToolHub å·¥å…·å±‚

#### 3.4.1 å·¥å…·æ³¨å†Œ

| å·¥å…· | è¯´æ˜ | å½“å‰çŠ¶æ€ |
|------|------|---------|
| SearchTool | å­¦æœ¯æ£€ç´¢ | å·²å®ç° |
| MultiModalRAGTool | åŸºäºä¸Šä¼ æ–‡æ¡£è¿›è¡Œå¤šæ¨¡æ€é—®ç­” | é¢„ç•™ |
| SummarizeTool | å¯¹æ£€ç´¢ç»“æœè¿›è¡Œå½’çº³æ€»ç»“ | é¢„ç•™ |
| FilterTool | ç­›é€‰ä¸æ’åºæ£€ç´¢ç»“æœ | é¢„ç•™ |
| CitationTool | è‡ªåŠ¨ç”Ÿæˆå¼•ç”¨æ ¼å¼ | é¢„ç•™ |
| DocTool | æ–‡æ¡£ç®¡ç†å·¥å…· | é¢„ç•™ |
| DocEditTool | æ–‡æ¡£å†…å®¹ç¼–è¾‘ï¼ˆæ”¯æŒword/markdown/textï¼‰ | å·²å®ç° |
| ProfileTool | ç”¨æˆ·ç”»åƒå·¥å…· | é¢„ç•™ |

**DocEditTool åŠŸèƒ½**ï¼š
- `read(doc_id)`: è¯»å–æ–‡æ¡£å…¨æ–‡
- `update(doc_id, content)`: å…¨æ–‡æ›¿æ¢
- `append(doc_id, content)`: æœ«å°¾è¿½åŠ å†…å®¹
- `replace(doc_id, old_text, new_text)`: æ›¿æ¢æŒ‡å®šç‰‡æ®µ
- **æ”¯æŒæ ¼å¼**ï¼š.docx/.doc (word)ã€.md (markdown)ã€.txt (text)

**å…¶ä»–å·¥å…·è¯´æ˜**ï¼š
- `SearchTool`: å­¦æœ¯æ£€ç´¢ï¼Œæ”¯æŒå…³é”®è¯ã€æœ€å¤§è¿”å›æ•°ã€å¹´ä»½èŒƒå›´ç­›é€‰
- `MultiModalRAGTool`: åŸºäºä¸Šä¼ æ–‡æ¡£è¿›è¡Œå¤šæ¨¡æ€é—®ç­”ï¼ˆé¢„ç•™ï¼‰
- `SummarizeTool`: å¯¹æ£€ç´¢ç»“æœè¿›è¡Œå½’çº³æ€»ç»“ï¼ˆé¢„ç•™ï¼‰
- `FilterTool`: ç­›é€‰ä¸æ’åºæ£€ç´¢ç»“æœï¼ˆé¢„ç•™ï¼‰
- `CitationTool`: è‡ªåŠ¨ç”Ÿæˆå¼•ç”¨æ ¼å¼ï¼ˆé¢„ç•™ï¼‰
- `DocTool`: æ–‡æ¡£ç®¡ç†å·¥å…·ï¼ˆé¢„ç•™ï¼‰
- `ProfileTool`: ç”¨æˆ·ç”»åƒå·¥å…·ï¼ˆé¢„ç•™ï¼‰

### 3.5 API å±‚è®¾è®¡

| è·¯ç”±å‰ç¼€ | æ–‡ä»¶ | æ¥å£æ•° | è¯´æ˜ |
|---------|------|--------|------|
| `/api/v1/chat` | `endpoints/chat.py` | 5 ä¸ª | èŠå¤© SSE + ä¼šè¯ CRUD + æ¶ˆæ¯æŸ¥è¯¢ |
| `/api/v1/documents` | `endpoints/documents.py` | 10 ä¸ª | æ–‡æ¡£ä¸Šä¼ /åˆ—è¡¨/åˆ é™¤/ç§»åŠ¨ + æ–‡ä»¶å¤¹ CRUD + å†…å®¹è¯»å†™ |
| `/api/v1/users` | `endpoints/users.py` | 2 ä¸ª | èµ„æ–™æŸ¥è¯¢/æ›´æ–° |
| `/health` | `server.py` | 1 ä¸ª | å¥åº·æ£€æŸ¥ |

> è¯¦ç»†æ¥å£è§„èŒƒè§ [API æ¥å£æ–‡æ¡£](./APIæ¥å£æ–‡æ¡£.md)

---

## 4. å‰ç«¯è¯¦ç»†è®¾è®¡

### 4.1 é¡µé¢è·¯ç”±

| è·¯ç”± | é¡µé¢æ–‡ä»¶ | è¯´æ˜ |
|------|---------|------|
| `/` | `app/page.tsx` | æ™ºèƒ½åŠ©æ‰‹ï¼ˆä¸»é¡µï¼‰ï¼Œé›†æˆèŠå¤©ã€æ–‡æ¡£ç®¡ç†ã€æ–‡æ¡£ç¼–è¾‘ |
| `/profile` | `app/profile/page.tsx` | ä¸ªäººä¸­å¿ƒ |

### 4.2 ç»„ä»¶æ ‘

```
RootLayout (layout.tsx)
â”œâ”€â”€ Navbar                          â† æ‰€æœ‰é¡µé¢å…±äº«
â””â”€â”€ Page Content
    â””â”€â”€ ChatPage (/)
        â”œâ”€â”€ Sidebar                 â† å†å²è®°å½•
        â”œâ”€â”€ PaperPanel              â† è®ºæ–‡ç®¡ç†ï¼ˆå¯æ‹–æ‹½è°ƒæ•´å®½åº¦ï¼‰
        â”‚   â”œâ”€â”€ FolderList         â† æ–‡ä»¶å¤¹åˆ—è¡¨
        â”‚   â”œâ”€â”€ UploadArea        â† ä¸Šä¼ åŒºåŸŸ
        â”‚   â”œâ”€â”€ DocumentList      â† æ–‡æ¡£åˆ—è¡¨
        â”‚   â””â”€â”€ Pagination         â† åˆ†é¡µ
        â”œâ”€â”€ DocContentPanel           â† æ–‡æ¡£å†…å®¹ï¼ˆå¯æ‹–æ‹½è°ƒæ•´å®½åº¦ï¼‰
        â”‚   â”œâ”€â”€ DocViewer/Editor  â† æ–‡æ¡£æŸ¥çœ‹/ç¼–è¾‘å™¨
        â”œâ”€â”€ ChatMessage[]           â† æ¶ˆæ¯æ°”æ³¡åˆ—è¡¨
        â”œâ”€â”€ TaskProgress            â† Agent ä»»åŠ¡è¿›åº¦å¡ç‰‡
        â””â”€â”€ InputArea               â† è¾“å…¥æ¡† + æŒ‰é’® + å¼€å…³
```

### 4.3 çŠ¶æ€ç®¡ç†

ä½¿ç”¨ React `useState` + é¡µé¢çº§çŠ¶æ€ï¼Œä¸å¼•å…¥å…¨å±€çŠ¶æ€ç®¡ç†åº“ã€‚

**ChatPage æ ¸å¿ƒçŠ¶æ€**:
| çŠ¶æ€ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `messages` | `Msg[]` | å½“å‰ä¼šè¯çš„æ¶ˆæ¯åˆ—è¡¨ |
| `input` | `string` | è¾“å…¥æ¡†å†…å®¹ |
| `isLoading` | `boolean` | æ˜¯å¦ç­‰å¾…å›å¤ |
| `sessionId` | `string \| null` | å½“å‰ä¼šè¯ ID |
| `mode` | `"normal" \| "agent"` | å¯¹è¯æ¨¡å¼ |
| `webSearch` | `boolean` | è”ç½‘æœç´¢å¼€å…³ |
| `taskSteps` | `TaskStep[]` | Agent ä»»åŠ¡æ­¥éª¤åˆ—è¡¨ |
| `agentThought` | `string` | Agent æ€è€ƒå†…å®¹ |
| `stepThoughts` | `Record<string, string>` | å„æ­¥éª¤æ€»ç»“ |
| `streamingContent` | `string` | æµå¼ç´¯ç§¯çš„å†…å®¹ |
| `selectedDocumentIds` | `string[]` | é€‰ä¸­çš„æ–‡æ¡£ ID åˆ—è¡¨ |
| `documents` | `any[]` | æ–‡æ¡£åˆ—è¡¨ |
| `folders` | `any[]` | æ–‡ä»¶å¤¹åˆ—è¡¨ |
| `selectedDoc` | `any` | å½“å‰é€‰ä¸­çš„æ–‡æ¡£ |
| `docContent` | `string \| null` | æ–‡æ¡£å†…å®¹ |
| `docEditingContent` | `string` | æ–‡æ¡£ç¼–è¾‘å†…å®¹ |

### 4.4 API å®¢æˆ·ç«¯ (`lib/api.ts`)

æ‰€æœ‰åç«¯è°ƒç”¨å°è£…åœ¨ `lib/api.ts` ä¸­ï¼Œå‰ç«¯ç»„ä»¶ä¸ç›´æ¥ä½¿ç”¨ `fetch`ã€‚

**é‡è¦**ï¼šèŠå¤© SSE è¯·æ±‚ç›´æ¥è®¿é—®åç«¯åœ°å€ï¼ˆ`BACKEND_BASE`ï¼‰ï¼Œç»•è¿‡ Next.js ä»£ç†ï¼Œé¿å…ç¼“å†²é—®é¢˜ã€‚

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `fetchSSEChat()` | æ ¸å¿ƒï¼šå‘é€æ¶ˆæ¯å¹¶è§£æ SSE äº‹ä»¶æµ |
| `getSessions()` | è·å–ä¼šè¯åˆ—è¡¨ |
| `deleteSession()` | åˆ é™¤ä¼šè¯ |
| `getMessages()` | è·å–ä¼šè¯æ¶ˆæ¯å†å² |
| `uploadDocument()` | ä¸Šä¼ æ–‡æ¡£ï¼ˆFormDataï¼‰ |
| `getDocuments()` | åˆ†é¡µè·å–æ–‡æ¡£åˆ—è¡¨ |
| `deleteDocument()` | åˆ é™¤æ–‡æ¡£ |
| `createFolder()` | åˆ›å»ºæ–‡ä»¶å¤¹ |
| `getFolders()` | è·å–æ–‡ä»¶å¤¹åˆ—è¡¨ |
| `deleteFolder()` | åˆ é™¤æ–‡ä»¶å¤¹ |
| `getDocumentContent()` | è·å–æ–‡æ¡£å†…å®¹ |
| `updateDocumentContent()` | æ›´æ–°æ–‡æ¡£å†…å®¹ |
| `getProfile()` | è·å–ç”¨æˆ·èµ„æ–™ |
| `updateProfile()` | æ›´æ–°ç”¨æˆ·èµ„æ–™ |

### 4.5 SSE è§£ææµç¨‹

```typescript
// å‰ç«¯ SSE è§£ææ ¸å¿ƒé€»è¾‘
const reader = response.body.getReader();
const decoder = new TextDecoder();
let buffer = "";

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  buffer += decoder.decode(value, { stream: true });

  // æŒ‰ \n\n åˆ†å‰²äº‹ä»¶
  const parts = buffer.split("\n\n");
  buffer = parts.pop() || "";  // æœ€åä¸€æ®µå¯èƒ½ä¸å®Œæ•´ï¼Œç•™åœ¨ buffer

  for (const part of parts) {
    // è§£æ event: å’Œ data: è¡Œ
    // æ ¹æ® event type åˆ†å‘å¤„ç†ï¼ˆplan/step_start/stream/done/doc_updated ç­‰ï¼‰
  }
}
```

---

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 ER å›¾

```mermaid
erDiagram
    sessions ||--o{ messages : "has"
    folders ||--o{ documents : "contains"
    folders ||--o{ folders : "parent"
    user_profiles ||--o{ sessions : "owns"
    user_profiles ||--o{ documents : "owns"
    user_profiles ||--o{ folders : "owns"

    sessions {
        text id PK
        text user_id FK
        text title
        text mode
        text created_at
        text updated_at
    }

    messages {
        text id PK
        text session_id FK
        text role
        text content
        text msg_type
        text metadata_json
        text created_at
    }

    documents {
        text id PK
        text user_id FK
        text folder_id FK
        text filename
        text original_name
        text file_path
        int file_size
        text file_type
        text status
        text created_at
    }

    folders {
        text id PK
        text user_id FK
        text name
        text parent_id FK
        text created_at
    }

    user_profiles {
        text user_id PK
        text display_name
        text created_at
        text updated_at
    }
```

**å…³ç³»è¯´æ˜**ï¼š

- `sessions` â”€â”€< `messages`ï¼šä¸€å¯¹å¤šï¼Œçº§è”åˆ é™¤ã€‚
- `folders` â”€â”€< `documents`ï¼šä¸€å¯¹å¤šï¼Œåˆ é™¤æ–‡ä»¶å¤¹æ—¶ `folder_id` ç½® NULLã€‚
- `folders` â”€â”€< `folders`ï¼šè‡ªå¼•ç”¨ï¼Œæ”¯æŒåµŒå¥—ã€‚
- `user_profiles` ä¸ sessionsã€documentsã€folders å‡ä¸ºç”¨æˆ·ç»´åº¦å…³è”ã€‚

### 5.2 è¡¨ç»“æ„

#### sessionsï¼ˆä¼šè¯ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | TEXT | PK | UUID |
| user_id | TEXT | NOT NULL, INDEX | ç”¨æˆ· ID |
| title | TEXT | NOT NULL | ä¼šè¯æ ‡é¢˜ï¼ˆè‡ªåŠ¨ä»é¦–æ¡æ¶ˆæ¯æå–ï¼‰ |
| mode | TEXT | NOT NULL | "normal" / "agent" |
| created_at | TEXT | NOT NULL | ISO8601 |
| updated_at | TEXT | NOT NULL | ISO8601ï¼Œæ¯æ¡æ¶ˆæ¯æ›´æ–° |

#### messagesï¼ˆæ¶ˆæ¯ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | TEXT | PK | UUID |
| session_id | TEXT | FK â†’ sessions.id, INDEX | æ‰€å±ä¼šè¯ |
| role | TEXT | NOT NULL | "user" / "assistant" |
| content | TEXT | NOT NULL | æ¶ˆæ¯å†…å®¹ |
| msg_type | TEXT | NOT NULL | "text" |
| metadata_json | TEXT | NULLABLE | JSON å­—ç¬¦ä¸²ï¼ŒAgent æ¨¡å¼å­˜ papers/citations/task_plan/agent_thought/step_thoughts |
| created_at | TEXT | NOT NULL | ISO8601 |

#### documentsï¼ˆæ–‡æ¡£ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | TEXT | PK | UUID |
| user_id | TEXT | NOT NULL, INDEX | æ‰€å±ç”¨æˆ· |
| folder_id | TEXT | FK â†’ folders.id, INDEX | æ‰€å±æ–‡ä»¶å¤¹ï¼ˆå¯ä¸º NULLï¼‰ |
| filename | TEXT | NOT NULL | å­˜å‚¨æ–‡ä»¶å `{uuid}.ext` |
| original_name | TEXT | NOT NULL | åŸå§‹æ–‡ä»¶å |
| file_path | TEXT | NOT NULL | æœåŠ¡å™¨æ–‡ä»¶è·¯å¾„ |
| file_size | INTEGER | NOT NULL | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| file_type | TEXT | NOT NULL | pdf/word/markdown/text/other |
| status | TEXT | NOT NULL | uploaded/processing/ready/error |
| created_at | TEXT | NOT NULL | ISO8601 |

#### foldersï¼ˆæ–‡ä»¶å¤¹ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | TEXT | PK | UUID |
| user_id | TEXT | NOT NULL, INDEX | æ‰€å±ç”¨æˆ· |
| name | TEXT | NOT NULL | æ–‡ä»¶å¤¹åç§° |
| parent_id | TEXT | FK â†’ folders.id | çˆ¶æ–‡ä»¶å¤¹ï¼ˆåµŒå¥—æ”¯æŒï¼‰ |
| created_at | TEXT | NOT NULL | ISO8601 |

#### user_profilesï¼ˆç”¨æˆ·èµ„æ–™ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| user_id | TEXT | PK | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| display_name | TEXT | NOT NULL | æ˜¾ç¤ºåç§° |
| created_at | TEXT | NOT NULL | ISO8601 |
| updated_at | TEXT | NOT NULL | ISO8601 |

### 5.3 ç´¢å¼•

```sql
CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_messages_session ON messages(session_id);
CREATE INDEX idx_documents_user ON documents(user_id);
CREATE INDEX idx_documents_folder ON documents(folder_id);
CREATE INDEX idx_folders_user ON folders(user_id);
```

---

## 6. Agent æ ¸å¿ƒæµç¨‹

### 6.1 æ™®é€šæ¨¡å¼ (`run_normal_chat`)

```
è¾“å…¥: message, session_id, history, document_ids
  â”‚
  â”œâ”€ è°ƒç”¨ LLM æµå¼ç”Ÿæˆå›ç­”
  â”œâ”€ åˆ†å—æµå¼è¾“å‡º
  â”‚   â””â”€ yield SSE: stream Ã— N
  â”œâ”€ å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯åˆ° DB
  â””â”€ yield SSE: done
```

### 6.2 Agent æ¨¡å¼ (`run_agent_chat`)

```
è¾“å…¥: message, session_id, history, web_search, document_ids
  â”‚
  â”œâ”€ [è§„åˆ’é˜¶æ®µ]
  â”‚   â”œâ”€ yield SSE: step_start (step_id="analyze")
  â”‚   â”œâ”€ ä½¿ç”¨ LLM ç”Ÿæˆè®¡åˆ’ï¼ˆå« thoughtï¼‰
  â”‚   â””â”€ yield SSE: plan (todo_list + thought)
  â”‚
  â”œâ”€ [æ‰§è¡Œé˜¶æ®µ] éå† plan ä¸­çš„æ¯ä¸ªæ­¥éª¤
  â”‚   â”œâ”€ yield SSE: step_start
  â”‚   â”œâ”€ è°ƒç”¨å¯¹åº”å·¥å…·
  â”‚   â”œâ”€ yield SSE: step_progress Ã— N
  â”‚   â”œâ”€ ç”Ÿæˆ step_thought_summary
  â”‚   â””â”€ yield SSE: step_complete (result + thought_summary)
  â”‚   â””â”€ (å¦‚æœæ˜¯ DocEditTool ä¸”ä¿®æ”¹æˆåŠŸï¼Œyield SSE: doc_updated
  â”‚
  â”œâ”€ [ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ]
  â”‚   â”œâ”€ yield SSE: step_start (step_id="final")
  â”‚   â”œâ”€ è°ƒç”¨ LLM æµå¼ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
  â”‚   â””â”€ yield SSE: stream Ã— N
  â”‚
  â”œâ”€ å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯åˆ° DBï¼ˆå« metadata: papers, citations, tool_results, task_plan, agent_thought, step_thoughtsï¼‰
  â””â”€ yield SSE: done
```

---

## 7. SSE æµå¼åè®®

### 7.1 æœåŠ¡ç«¯ SSE ç”Ÿæˆæµç¨‹

```mermaid
flowchart TD
    A[chat ç«¯ç‚¹æ”¶åˆ° POST] --> B[add_message user]
    B --> C{mode?}
    C -->|normal| D[run_normal_chat ç”Ÿæˆå™¨]
    C -->|agent| E[run_agent_chat ç”Ÿæˆå™¨]
    D --> F[stream Ã— N]
    E --> F
    F --> G[add_message assistant]
    G --> H[yield done äº‹ä»¶]
    H --> I[StreamingResponse ç»“æŸ]
```

### 7.2 ä¼ è¾“æ ¼å¼

```
event: {event_type}\n
data: {json_object}\n
\n
```

### 7.3 äº‹ä»¶ç±»å‹

| äº‹ä»¶ | data å­—æ®µ | å‰ç«¯å¤„ç† |
|------|-----------|----------|
| `plan` | `plan: [], thought: string | æ¸²æŸ“ä»»åŠ¡è®¡åˆ’å¡ç‰‡ï¼Œæ˜¾ç¤º thought |
| `step_start` | `step_id: string, action: string` | å¯¹åº”æ­¥éª¤çŠ¶æ€å˜ä¸º "running" |
| `step_progress` | `step_id: string, progress: number, message: string` | æ›´æ–°è¿›åº¦æ¡å’Œæç¤ºæ–‡å­— |
| `step_complete` | `step_id: string, result: object, thought_summary: string` | å¯¹åº”æ­¥éª¤çŠ¶æ€å˜ä¸º "done"ï¼Œæ˜¾ç¤ºæ­¥éª¤æ€»ç»“ |
| `stream` | `content: string` | ç´¯åŠ å†…å®¹åˆ° streamingContentï¼Œå®æ—¶æ¸²æŸ“ |
| `doc_updated` | `doc_id: string` | åˆ·æ–°å¯¹åº”æ–‡æ¡£å†…å®¹ |
| `done` | `content: string` | æ ‡è®°å®Œæˆï¼Œä¿å­˜æ¶ˆæ¯ |

---

## 8. å¼€å‘è§„èŒƒ

### 8.1 ç¯å¢ƒå˜é‡

åç«¯ `.env` ç¤ºä¾‹ï¼š

```env
# LLM é…ç½®
OPENAI_API_KEY=your_api_key_here
OPENAI_BASE_URL=https://api.deepseek.com/v1
OPENAI_MODEL=deepseek-chat

# åç«¯é…ç½®
BACKEND_PORT=8088
```

å‰ç«¯ `.env.local` ç¤ºä¾‹ï¼š

```env
NEXT_PUBLIC_BACKEND_BASE=http://localhost:8088
```

### 8.2 å¯åŠ¨æ–¹å¼

**åç«¯å¯åŠ¨**:
```bash
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
python server.py
```

**å‰ç«¯å¯åŠ¨**:
```bash
cd frontend
npm install
npm run dev
```

æˆ–ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„ `start.sh` ä¸€é”®å¯åŠ¨ã€‚

