# Scholar Agent æŠ€æœ¯å¼€å‘æ–¹æ¡ˆ

> ç‰ˆæœ¬: v2.0 | æ›´æ–°æ—¥æœŸ: 2026-02-20
>
> å…³è”æ–‡æ¡£: [PRD](./äº§å“éœ€æ±‚æ–‡æ¡£.md) Â· [API æ¥å£æ–‡æ¡£](./APIæ¥å£æ–‡æ¡£.md) Â· [å‰ç«¯äº¤äº’æ–‡æ¡£](./å‰ç«¯äº¤äº’æ–‡æ¡£.md)

---

## ç›®å½•

1. [é¡¹ç›®æ€»è§ˆ](#1-é¡¹ç›®æ€»è§ˆ)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [åç«¯è¯¦ç»†è®¾è®¡](#3-åç«¯è¯¦ç»†è®¾è®¡)
4. [å‰ç«¯è¯¦ç»†è®¾è®¡](#4-å‰ç«¯è¯¦ç»†è®¾è®¡)
5. [æ•°æ®åº“è®¾è®¡](#5-æ•°æ®åº“è®¾è®¡)
6. [Agent æ ¸å¿ƒæµç¨‹](#6-agent-æ ¸å¿ƒæµç¨‹)
7. [SSE æµå¼åè®®](#7-sse-æµå¼åè®®)
8. [å¼€å‘è§„èŒƒ](#8-å¼€å‘è§„èŒƒ)

---

## 1. é¡¹ç›®æ€»è§ˆ

### 1.1 é¡¹ç›®ä¿¡æ¯

| å±æ€§ | å†…å®¹ |
|------|------|
| é¡¹ç›®åç§° | Scholar Agentï¼ˆæ™ºèƒ½å­¦æœ¯åŠ©æ‰‹ï¼‰ |
| åç«¯æ¡†æ¶ | Python 3.10+ / FastAPI |
| å‰ç«¯æ¡†æ¶ | Next.js 14 / TypeScript / Tailwind CSS |
| Agent ç¼–æ’ | ReAct æ¨¡å¼ï¼ˆæ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯ï¼‰ |
| LLM æ¥å…¥ | æ”¯æŒ DeepSeekã€åƒé—®ç­‰ä¸åŒçš„æ¨¡å‹æ¥å…¥ |
| æ•°æ®å­˜å‚¨ | SQLite |
| ç¼“å­˜ | Redis + å†…å­˜ç¼“å­˜ï¼ˆæ”¯æŒç¼“å­˜å‡»ç©¿ã€ç©¿é€ã€é›ªå´©é˜²æŠ¤ï¼‰ |
| æ–‡ä»¶å­˜å‚¨ | æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆæŒ‰ç”¨æˆ·IDéš”ç¦»ï¼‰ |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 ç³»ç»Ÿåˆ†å±‚æ¶æ„å›¾ï¼ˆæ€»è§ˆï¼‰

```mermaid
block-beta
    columns 5

    block:header:5
        columns 1
        title["Scholar Agent æ™ºèƒ½å­¦æœ¯åŠ©æ‰‹"]
    end

    space:5

    block:access_label:1
        al["æ¥å…¥å±‚"]
    end
    block:access:4
        columns 4
        web["Web å‰ç«¯"]
        api["RESTful API"]
        sdk["SDK"]
        app["ç§»åŠ¨ç«¯ APP"]
    end

    space:5

    block:app_label:1
        apl["åº”ç”¨å±‚"]
    end
    block:application:4
        columns 4
        plan["ä»»åŠ¡è§„åˆ’"]
        tool_call["å·¥å…·è°ƒç”¨"]
        session["ä¼šè¯ç®¡ç†"]
        rag["RAG é—®ç­”"]
        hitl["äººå·¥å¹²é¢„"]
        router["æ™ºèƒ½è·¯ç”±"]
        user_mgmt["ç”¨æˆ·ç®¡ç†"]
        doc_mgmt["æ–‡æ¡£ç®¡ç†"]
    end

    space:5

    block:tool_label:1
        tl["å·¥å…·å±‚"]
    end
    block:doc_tools:1
        columns 1
        dt_title["Document å·¥å…·"]
        dt1["å¤šæ¨¡æ€è§£æ"]
        dt2["æ–‡æ¡£ç¼–è¾‘"]
        dt3["çŸ¥è¯†åº“æ„å»º"]
    end
    block:search_tools:1
        columns 1
        st_title["æ£€ç´¢å·¥å…·"]
        st1["è”ç½‘æ£€ç´¢"]
        st2["æœ¬åœ°æ£€ç´¢"]
        st3["ç­›é€‰æ’åº"]
    end
    block:content_tools:1
        columns 1
        ct_title["å†…å®¹å¤„ç†å·¥å…·"]
        ct1["å½’çº³æ€»ç»“"]
        ct2["å¼•ç”¨ç”Ÿæˆ"]
        space
    end
    block:user_tools:1
        columns 1
        ut_title["ç”¨æˆ·å·¥å…·"]
        ut1["ç”¨æˆ·ç”»åƒ"]
        ut2["ä¸ªæ€§åŒ–"]
        space
    end

    space:5

    block:infra_label:1
        il["åŸºå»ºå±‚"]
    end
    block:infra:2
        columns 2
        infra_title["åŸºç¡€è®¾æ–½"]
        space
        ext_api["å¤–éƒ¨å­¦æœ¯èµ„æºåº“"]
        llm["å¤§æ¨¡å‹è°ƒåº¦"]
        security["å®‰å…¨å®¡æ ¸"]
        log["æ—¥å¿—ç³»ç»Ÿ"]
        async["å¼‚æ­¥å¤„ç†"]
        space
    end
    block:storage:2
        columns 4
        storage_title["æ•°æ®å­˜å‚¨"]:4
        sqlite[("SQLite")]
        redis[("Redis")]
        fs[("æ–‡ä»¶ç³»ç»Ÿ")]
        milvus[("Milvus")]
    end

    style header fill:#e8eaf6,stroke:#5c6bc0
    style access fill:#e3f2fd,stroke:#42a5f5
    style application fill:#fff8e1,stroke:#ffc107
    style doc_tools fill:#f3e5f5,stroke:#ab47bc
    style search_tools fill:#f3e5f5,stroke:#ab47bc
    style content_tools fill:#f3e5f5,stroke:#ab47bc
    style user_tools fill:#f3e5f5,stroke:#ab47bc
    style infra fill:#fce4ec,stroke:#ef5350
    style storage fill:#fce4ec,stroke:#ef5350
```

> **å¤‡æ³¨**ï¼šå¦‚æœ Mermaid Block Diagram ä¸è¢«æ¸²æŸ“ç¯å¢ƒæ”¯æŒï¼Œå¯å‚è€ƒä¸‹æ–¹æ›¿ä»£ç‰ˆæœ¬ã€‚

**æ›¿ä»£ç‰ˆï¼ˆflowchart æ–¹å¼ï¼‰**ï¼š

```mermaid
flowchart TB
    subgraph L0["Scholar Agent æ™ºèƒ½å­¦æœ¯åŠ©æ‰‹"]
        direction TB

        subgraph L1["ğŸ”Œ æ¥å…¥å±‚"]
            direction LR
            L1_web["Web å‰ç«¯<br/>Next.js"]
            L1_api["RESTful API<br/>FastAPI"]
            L1_sdk["SDK"]
            L1_app["ç§»åŠ¨ç«¯ APP"]
        end

        subgraph L2["ğŸ§  åº”ç”¨å±‚ â€” Agent Application"]
            direction LR
            subgraph L2_agent["Agent ç¼–æ’å¼•æ“"]
                direction LR
                L2_plan["ä»»åŠ¡è§„åˆ’"]
                L2_exec["å·¥å…·è°ƒç”¨"]
                L2_route["æ™ºèƒ½è·¯ç”±"]
                L2_hitl["äººå·¥å¹²é¢„"]
            end
            subgraph L2_svc["ä¸šåŠ¡æœåŠ¡"]
                direction LR
                L2_session["ä¼šè¯ç®¡ç†"]
                L2_rag["RAG é—®ç­”"]
                L2_user["ç”¨æˆ·ç®¡ç†"]
                L2_doc["æ–‡æ¡£ç®¡ç†"]
            end
        end

        subgraph L3["ğŸ”§ å·¥å…·å±‚"]
            direction LR
            subgraph L3_doc["Document å·¥å…·"]
                L3_d1["å¤šæ¨¡æ€è§£æ"]
                L3_d2["æ–‡æ¡£ç¼–è¾‘"]
                L3_d3["çŸ¥è¯†åº“æ„å»º"]
            end
            subgraph L3_search["æ£€ç´¢å·¥å…·"]
                L3_s1["è”ç½‘æ£€ç´¢"]
                L3_s2["æœ¬åœ°æ£€ç´¢"]
                L3_s3["ç­›é€‰æ’åº"]
            end
            subgraph L3_content["å†…å®¹å¤„ç†å·¥å…·"]
                L3_c1["å½’çº³æ€»ç»“"]
                L3_c2["å¼•ç”¨ç”Ÿæˆ"]
            end
            subgraph L3_user["ç”¨æˆ·å·¥å…·"]
                L3_u1["ç”¨æˆ·ç”»åƒ"]
                L3_u2["ä¸ªæ€§åŒ–"]
            end
        end

        subgraph L4["âš™ï¸ åŸºå»ºå±‚"]
            direction LR
            subgraph L4_infra["åŸºç¡€è®¾æ–½"]
                L4_ext["å¤–éƒ¨å­¦æœ¯èµ„æºåº“"]
                L4_llm["å¤§æ¨¡å‹è°ƒåº¦"]
                L4_sec["å®‰å…¨å®¡æ ¸"]
                L4_log["æ—¥å¿—ç³»ç»Ÿ"]
                L4_async["å¼‚æ­¥å¤„ç†"]
            end
            subgraph L4_store["æ•°æ®å­˜å‚¨"]
                L4_sqlite[("SQLite")]
                L4_redis[("Redis")]
                L4_fs[("æ–‡ä»¶ç³»ç»Ÿ")]
                L4_milvus[("Milvus")]
            end
        end
    end

    L1 --> L2
    L2 --> L3
    L3 --> L4
    L2_agent --> L2_svc

    style L1 fill:#e3f2fd,stroke:#42a5f5
    style L2 fill:#fff8e1,stroke:#ffc107
    style L2_agent fill:#fff3e0,stroke:#ff9800
    style L2_svc fill:#fffde7,stroke:#fdd835
    style L3 fill:#f3e5f5,stroke:#ab47bc
    style L3_doc fill:#f8f0fc,stroke:#ce93d8
    style L3_search fill:#f8f0fc,stroke:#ce93d8
    style L3_content fill:#f8f0fc,stroke:#ce93d8
    style L3_user fill:#f8f0fc,stroke:#ce93d8
    style L4 fill:#fce4ec,stroke:#ef5350
    style L4_infra fill:#ffebee,stroke:#e57373
    style L4_store fill:#ffebee,stroke:#e57373
```

### 2.2 æ¶æ„å›¾è¯¦ç»†è¯´æ˜

ç³»ç»Ÿæ¶æ„åˆ†ä¸ºå››å±‚ï¼šæ¥å…¥å±‚ã€åº”ç”¨å±‚ã€å·¥å…·å±‚ã€åŸºå»ºå±‚ã€‚åº”ç”¨å±‚è¿›ä¸€æ­¥åˆ’åˆ†ä¸º **Agent ç¼–æ’å¼•æ“**ï¼ˆæ ¸å¿ƒè°ƒåº¦ï¼‰å’Œ**ä¸šåŠ¡æœåŠ¡**ï¼ˆé¢†åŸŸé€»è¾‘ï¼‰ä¸¤ä¸ªå­å±‚ã€‚

---

#### 2.2.1 æ¥å…¥å±‚

| ç»„ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **Web å‰ç«¯** | Next.js é¡µé¢ï¼Œlib/api.ts è°ƒç”¨åç«¯ | âœ… å·²æœ‰ |
| **RESTful API** | FastAPI è·¯ç”±ï¼ŒHTTP/SSE åè®® | âœ… å·²æœ‰ |
| **SDK** | ç¬¬ä¸‰æ–¹é›†æˆç”¨ SDK | ğŸ“… è§„åˆ’ä¸­ |
| **ç§»åŠ¨ç«¯ APP** | åŸç”Ÿç§»åŠ¨åº”ç”¨ | ğŸ“… è§„åˆ’ä¸­ |

---

#### 2.2.2 åº”ç”¨å±‚ï¼ˆAgent Applicationï¼‰

| å­å±‚ | æ¨¡å— | èŒè´£ | è¯´æ˜ |
|------|------|------|------|
| **Agent ç¼–æ’å¼•æ“** | ä»»åŠ¡è§„åˆ’ | å°†ç”¨æˆ·å¤æ‚ç›®æ ‡æ‹†åˆ†ä¸ºå¯æ‰§è¡Œ TODO åˆ—è¡¨ | âœ… Agent Service |
| | å·¥å…·è°ƒç”¨ | åè°ƒè°ƒç”¨å„å·¥å…·å®Œæˆä»»åŠ¡ | âœ… Agent Service |
| | æ™ºèƒ½è·¯ç”± | æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æœ€ä¼˜å¤„ç†è·¯å¾„ | ğŸ“… V2.0 |
| | äººå·¥å¹²é¢„ | å…³é”®èŠ‚ç‚¹æ”¯æŒäººå·¥ç¡®è®¤å’Œä¿®æ”¹ | ğŸ“… V2.0 |
| **ä¸šåŠ¡æœåŠ¡** | ä¼šè¯ç®¡ç† | ä¼šè¯ CRUDã€ä¸Šä¸‹æ–‡ç®¡ç† | âœ… SessionService |
| | RAG é—®ç­” | åŸºäºå¤šæ¨¡æ€çš„æ£€ç´¢å¢å¼ºé—®ç­” | ğŸ“… V1.0 |
| | ç”¨æˆ·ç®¡ç† | ç”¨æˆ·èµ„æ–™ã€ç”¨æˆ·ç”»åƒ | âœ… UserService |
| | æ–‡æ¡£ç®¡ç† | æ–‡ä»¶ç®¡ç†ã€çŸ¥è¯†åº“æ„å»º | âœ… DocumentService |

---

#### 2.2.3 å·¥å…·å±‚

| å·¥å…·åˆ†ç±» | å·¥å…· | è¯´æ˜ |
|---------|------|------|
| **Document å·¥å…·** | å¤šæ¨¡æ€è§£æ | PDF/Word/å›¾ç‰‡ç­‰æ–‡æ¡£è§£æ |
| | æ–‡æ¡£ç¼–è¾‘ | åœ¨çº¿ç¼–è¾‘æ–‡æ¡£å†…å®¹ |
| | çŸ¥è¯†åº“æ„å»º | æ–‡æ¡£ç´¢å¼•ä¸çŸ¥è¯†åº“å»ºç«‹ |
| **æ£€ç´¢å·¥å…·** | è”ç½‘æ£€ç´¢ | arXivã€å­¦æœ¯æœç´¢å¼•æ“ç­‰ |
| | æœ¬åœ°æ£€ç´¢ | æœ¬åœ°æ–‡æ¡£åº“æ£€ç´¢ |
| | ç­›é€‰æ’åº | ç»“æœç­›é€‰ä¸æ’åº |
| **å†…å®¹å¤„ç†å·¥å…·** | å½’çº³æ€»ç»“ | æ–‡çŒ®å½’çº³æ€»ç»“ |
| | å¼•ç”¨ç”Ÿæˆ | è‡ªåŠ¨ç”Ÿæˆå¼•ç”¨æ ¼å¼ |
| **ç”¨æˆ·å·¥å…·** | ç”¨æˆ·ç”»åƒ | æ„å»ºç”¨æˆ·ç ”ç©¶å…´è¶£ç”»åƒ |
| | ä¸ªæ€§åŒ– | ä¸ªæ€§åŒ–æ¨èä¸å†…å®¹é€‚é… |

---

#### 2.2.4 åŸºå»ºå±‚

##### åŸºç¡€è®¾æ–½

| ç»„ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **å¤–éƒ¨å­¦æœ¯èµ„æºåº“** | arXivã€å­¦æœ¯æœç´¢å¼•æ“ç­‰å¤–éƒ¨ API | âœ… å·²æœ‰ |
| **å¤§æ¨¡å‹è°ƒåº¦** | LLM è°ƒç”¨ï¼ˆDeepSeekã€åƒé—®ç­‰ï¼‰ | âœ… å·²æœ‰ |
| **å®‰å…¨å®¡æ ¸** | å†…å®¹å®‰å…¨ã€è¾“å…¥è¾“å‡ºå®¡æ ¸ | ğŸ“… è§„åˆ’ä¸­ |
| **æ—¥å¿—ç³»ç»Ÿ** | åº”ç”¨æ—¥å¿—ã€é”™è¯¯æ—¥å¿— | âœ… å·²æœ‰ |
| **å¼‚æ­¥å¤„ç†** | å¼‚æ­¥ä»»åŠ¡å¤„ç† | ğŸ“… è§„åˆ’ä¸­ |

##### æ•°æ®å­˜å‚¨

| ç»„ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|
| **SQLite** | å…³ç³»å‹å­˜å‚¨ï¼ˆä¼šè¯ã€æ¶ˆæ¯ã€æ–‡æ¡£ã€ç”¨æˆ·ç­‰ï¼‰ | âœ… å½“å‰ |
| **Redis** | ç¼“å­˜ã€ä¼šè¯ã€å¼‚æ­¥é˜Ÿåˆ— | ğŸ“… è§„åˆ’ä¸­ |
| **æ–‡ä»¶ç³»ç»Ÿ** | ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ | âœ… å·²æœ‰ |
| **Milvus** | å‘é‡æ£€ç´¢æ•°æ®åº“ | ğŸ“… V1.0 |

### 2.3 å±‚é—´è¯·æ±‚æµè½¬å›¾

```mermaid
flowchart LR
    subgraph Client["ğŸ‘¤ å®¢æˆ·ç«¯"]
        C1["ç”¨æˆ·"]
    end

    subgraph L1["ğŸ”Œ æ¥å…¥å±‚"]
        direction TB
        FE["Web å‰ç«¯ / SDK / APP"]
        API["FastAPI<br/>REST + SSE"]
        FE -->|"HTTP è¯·æ±‚"| API
    end

    subgraph L2["ğŸ§  åº”ç”¨å±‚"]
        direction TB
        Agent["Agent ç¼–æ’å¼•æ“<br/>Planner â†’ Executor â†’ Reflector"]
        Svc["ä¸šåŠ¡æœåŠ¡<br/>Session / Doc / User"]
        Agent -->|"è°ƒç”¨"| Svc
    end

    subgraph L3["ğŸ”§ å·¥å…·å±‚"]
        ToolHub["ToolHub å·¥å…·æ³¨å†Œä¸­å¿ƒ"]
        Tools["SearchTool / DocEditTool / ..."]
        ToolHub --> Tools
    end

    subgraph L4["âš™ï¸ åŸºå»ºå±‚"]
        direction TB
        LLM["å¤§æ¨¡å‹è°ƒåº¦<br/>DeepSeek / Qwen"]
        Ext["å¤–éƒ¨ API<br/>arXiv / å­¦æœ¯æœç´¢"]
        DB[("æ•°æ®å­˜å‚¨<br/>SQLite / Redis / Milvus")]
        FS[("æ–‡ä»¶ç³»ç»Ÿ")]
    end

    C1 -->|"æ“ä½œ"| FE
    API -->|"è·¯ç”±åˆ†å‘"| Agent
    Agent -->|"LLM æ¨ç†"| LLM
    Agent -->|"å·¥å…·è°ƒåº¦"| ToolHub
    Tools -->|"è¯»å†™æ•°æ®"| DB
    Tools -->|"æ£€ç´¢"| Ext
    Svc -->|"æŒä¹…åŒ–"| DB
    Svc -->|"æ–‡ä»¶è¯»å†™"| FS
    LLM -->|"ç”Ÿæˆç»“æœ"| Agent
    API -->|"SSE / JSON"| FE
    FE -->|"æ¸²æŸ“"| C1

    style Client fill:#f5f5f5,stroke:#9e9e9e
    style L1 fill:#e3f2fd,stroke:#42a5f5
    style L2 fill:#fff8e1,stroke:#ffc107
    style L3 fill:#f3e5f5,stroke:#ab47bc
    style L4 fill:#fce4ec,stroke:#ef5350
```

### 2.4 ç³»ç»Ÿæ•°æ®æµå›¾ï¼ˆè¯·æ±‚-å“åº”è·¯å¾„ï¼‰

```mermaid
flowchart LR
    subgraph ç”¨æˆ·ç«¯
        A["ç”¨æˆ·æ“ä½œ"]
    end

    subgraph å‰ç«¯["å‰ç«¯ (Next.js)"]
        B["é¡µé¢ç»„ä»¶<br/>ChatPage / DocPanel"]
        C["lib/api.ts<br/>API å®¢æˆ·ç«¯"]
        B --> C
    end

    subgraph åç«¯["åç«¯ (FastAPI)"]
        D["Router è·¯ç”±å±‚<br/>chat.py / documents.py"]
        E["Service æœåŠ¡å±‚<br/>AgentService / DocService"]
        F["æ•°æ®å±‚<br/>DB / æ–‡ä»¶ç³»ç»Ÿ / å¤–éƒ¨ API"]
        D --> E
        E --> F
    end

    A -->|"ç‚¹å‡» / è¾“å…¥"| B
    C -->|"fetch / SSEï¼ˆç›´è¿åç«¯ï¼‰"| D
    F -->|"æŸ¥è¯¢ç»“æœ"| E
    E -->|"ä¸šåŠ¡å“åº”"| D
    D -->|"JSON / SSE Stream"| C
    C -->|"æ›´æ–° state"| B
    B -->|"æ¸²æŸ“ UI"| A

    style ç”¨æˆ·ç«¯ fill:#f5f5f5,stroke:#9e9e9e
    style å‰ç«¯ fill:#e3f2fd,stroke:#42a5f5
    style åç«¯ fill:#fff8e1,stroke:#ffc107
```

### 2.5 èŠå¤©è¯·æ±‚å®Œæ•´æ—¶åºå›¾

```mermaid
sequenceDiagram
    actor User as ç”¨æˆ·
    participant FE as å‰ç«¯ (Next.js)
    participant API as FastAPI è·¯ç”±å±‚
    participant Session as SessionService
    participant Agent as AgentService
    participant LLM as LLM Scheduler
    participant TH as ToolHub
    participant DB as SQLite

    User->>FE: è¾“å…¥æ¶ˆæ¯ + ç‚¹å‡»å‘é€
    FE->>FE: ä¹è§‚æ›´æ–° UIï¼ˆæ·»åŠ ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡ï¼‰
    FE->>API: POST /api/v1/chat/chat<br/>{message, mode, session_id, document_ids}

    rect rgb(240, 248, 255)
        Note over API,DB: ä¼šè¯ä¸æ¶ˆæ¯æŒä¹…åŒ–
        API->>Session: create_session / get_session
        Session->>DB: SELECT / INSERT session
        API->>Session: add_message(role=user)
        Session->>DB: INSERT ç”¨æˆ·æ¶ˆæ¯
    end

    API-->>FE: StreamingResponseï¼ˆSSE è¿æ¥å»ºç«‹ï¼‰

    alt mode = normalï¼ˆæ™®é€šæ¨¡å¼ï¼‰
        rect rgb(255, 248, 225)
            Note over Agent,LLM: ç›´æ¥æµå¼ç”Ÿæˆ
            API->>Agent: run_normal_chat(message, history)
            Agent->>LLM: chat_stream(messages)
            loop æµå¼è¾“å‡º
                LLM-->>Agent: token chunk
                Agent-->>API: yield SSE
                API-->>FE: event: stream {content}
                FE->>FE: ç´¯åŠ  streamingContent å¹¶æ¸²æŸ“
            end
        end

    else mode = agentï¼ˆæ™ºèƒ½ä½“æ¨¡å¼ï¼‰
        rect rgb(255, 243, 224)
            Note over Agent,LLM: é˜¶æ®µä¸€ï¼šä»»åŠ¡è§„åˆ’
            API->>Agent: run_agent_chat(message, history, web_search)
            Agent-->>API: yield SSE
            API-->>FE: event: step_start {step_id: analyze}
            Agent->>LLM: ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ + thought
            LLM-->>Agent: plan JSON + thought
            Agent-->>API: yield SSE
            API-->>FE: event: plan {todo_list, thought}
            FE->>FE: æ¸²æŸ“ä»»åŠ¡è®¡åˆ’å¡ç‰‡
        end

        rect rgb(243, 229, 245)
            Note over Agent,TH: é˜¶æ®µäºŒï¼šé€æ­¥æ‰§è¡Œ
            loop éå† plan ä¸­çš„æ¯ä¸ªæ­¥éª¤
                Agent-->>API: yield SSE
                API-->>FE: event: step_start {step_id, action}
                FE->>FE: æ­¥éª¤çŠ¶æ€ â†’ running

                Agent->>TH: è°ƒç”¨å¯¹åº”å·¥å…· (SearchTool / DocEditTool / ...)
                TH-->>Agent: å·¥å…·æ‰§è¡Œç»“æœ

                Agent-->>API: yield SSE
                API-->>FE: event: step_progress {step_id, progress}

                Agent->>LLM: ç”Ÿæˆæ­¥éª¤æ€»ç»“ (thought_summary)
                LLM-->>Agent: thought_summary

                Agent-->>API: yield SSE
                API-->>FE: event: step_complete {step_id, result, thought_summary}
                FE->>FE: æ­¥éª¤çŠ¶æ€ â†’ done

                opt æ–‡æ¡£è¢«ä¿®æ”¹
                    Agent-->>API: yield SSE
                    API-->>FE: event: doc_updated {doc_id}
                    FE->>FE: åˆ·æ–°æ–‡æ¡£å†…å®¹é¢æ¿
                end
            end
        end

        rect rgb(232, 245, 233)
            Note over Agent,LLM: é˜¶æ®µä¸‰ï¼šç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ
            Agent-->>API: yield SSE
            API-->>FE: event: step_start {step_id: final}
            Agent->>LLM: chat_stream(ç»¼åˆæ‰€æœ‰å·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆå›ç­”)
            loop æµå¼è¾“å‡º
                LLM-->>Agent: token chunk
                Agent-->>API: yield SSE
                API-->>FE: event: stream {content}
                FE->>FE: ç´¯åŠ å†…å®¹å¹¶æ¸²æŸ“
            end
        end
    end

    rect rgb(240, 248, 255)
        Note over Agent,DB: æ¶ˆæ¯æŒä¹…åŒ–
        Agent->>Session: add_message(role=assistant, metadata)
        Session->>DB: INSERT åŠ©æ‰‹æ¶ˆæ¯ï¼ˆå« papers/citations/task_plan ç­‰ï¼‰
    end

    Agent-->>API: yield SSE
    API-->>FE: event: done {content}
    FE->>FE: å®Œæˆæ¶ˆæ¯æ¸²æŸ“ï¼Œæ›´æ–°ä¼šè¯æ ‡é¢˜
```

### 2.6 æ¨¡å—ä¾èµ–å…³ç³»å›¾

```mermaid
graph TB
    subgraph API["API è·¯ç”±å±‚"]
        chat_ep["chat.py"]
        doc_ep["documents.py"]
        user_ep["users.py"]
    end

    subgraph Services["ä¸šåŠ¡æœåŠ¡å±‚"]
        session_svc["SessionService<br/>ä¼šè¯ / æ¶ˆæ¯ CRUD"]
        agent_svc["AgentService<br/>Agent ç¼–æ’å¼•æ“"]
        doc_svc["DocumentService<br/>æ–‡æ¡£ / æ–‡ä»¶å¤¹ CRUD"]
        user_svc["UserService<br/>ç”¨æˆ·èµ„æ–™"]
    end

    subgraph Domain["é¢†åŸŸå±‚"]
        llm_scheduler["LLM Scheduler<br/>æ¨¡å‹è°ƒåº¦"]
    end

    subgraph Tools["å·¥å…·å±‚"]
        toolhub["ToolHub<br/>å·¥å…·æ³¨å†Œä¸­å¿ƒ"]
        search["SearchTool"]
        docedit["DocEditTool"]
        more_tools["å…¶ä»–å·¥å…·..."]
        toolhub --> search & docedit & more_tools
    end

    subgraph Infra["åŸºç¡€è®¾æ–½"]
        db[("SQLite")]
        fs[("æ–‡ä»¶ç³»ç»Ÿ")]
        llm_api["LLM API<br/>OpenAI SDK"]
        ext_api["å¤–éƒ¨ API<br/>arXiv ç­‰"]
    end

    chat_ep --> session_svc
    chat_ep --> agent_svc
    doc_ep --> doc_svc
    user_ep --> user_svc

    agent_svc --> session_svc
    agent_svc --> llm_scheduler
    agent_svc --> toolhub
    agent_svc --> doc_svc

    docedit -.->|"è¯»å†™æ–‡æ¡£"| doc_svc
    search -.->|"å¤–éƒ¨æ£€ç´¢"| ext_api

    llm_scheduler --> llm_api

    session_svc & doc_svc & user_svc --> db
    doc_svc --> fs

    style API fill:#e3f2fd,stroke:#42a5f5
    style Services fill:#fff8e1,stroke:#ffc107
    style Domain fill:#e8f5e9,stroke:#66bb6a
    style Tools fill:#f3e5f5,stroke:#ab47bc
    style Infra fill:#fce4ec,stroke:#ef5350
```

### 2.7 æ–‡æ¡£ä¸Šä¼ ä¸ç¼–è¾‘æµç¨‹å›¾

```mermaid
flowchart TD
    Start(("å¼€å§‹")) --> A

    subgraph ç”¨æˆ·ä¸Šä¼ ["ğŸ“¤ ç”¨æˆ·ä¸Šä¼ æµç¨‹"]
        A["ç”¨æˆ·é€‰æ‹©/æ‹–æ‹½æ–‡ä»¶"] --> B["å‰ç«¯æ„é€  FormData"]
        B --> C["POST /api/v1/documents/upload"]
        C --> D["API æ ¡éªŒ Content-Type å’Œæ–‡ä»¶å¤§å°"]
        D --> E{"ç±»å‹åˆæ³•ï¼Ÿ"}
        E -->|"å¦"| F["400 Bad Request<br/>è¿”å›é”™è¯¯æç¤º"]
        E -->|"æ˜¯"| G["DocumentService.upload_document"]
        G --> H["ç”Ÿæˆ UUID æ–‡ä»¶å"]
        H --> I["å†™å…¥ data/uploads/"]
        I --> J["INSERT documents è¡¨"]
        J --> K["è¿”å› document å¯¹è±¡"]
        K --> L["å‰ç«¯åˆ·æ–°æ–‡æ¡£åˆ—è¡¨"]
    end

    L --> M["ç”¨æˆ·ç‚¹å‡»æ–‡æ¡£æŸ¥çœ‹"]
    M --> N{"æ–‡æ¡£ç±»å‹ï¼Ÿ"}

    subgraph æ–‡æ¡£æŸ¥çœ‹ç¼–è¾‘["ğŸ“ æ–‡æ¡£æŸ¥çœ‹ä¸ç¼–è¾‘"]
        N -->|"PDF"| O["è§£æ PDF æ–‡æœ¬<br/>åªè¯»æ˜¾ç¤º"]
        N -->|"Word / Markdown / Text"| P["æ˜¾ç¤ºå¯ç¼–è¾‘æ–‡æœ¬æ¡†"]
        P --> Q["ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹å†…å®¹"]
        Q --> R["PUT /documents/{id}/content"]
        R --> S["DocumentService.update_document_content"]
        S --> T["å†™å…¥æ–‡ä»¶ + æ›´æ–° DB"]
        T --> U["å‰ç«¯åˆ·æ–°æ–‡æ¡£å†…å®¹"]
    end

    subgraph Agentç¼–è¾‘["ğŸ¤– Agent è‡ªåŠ¨ç¼–è¾‘"]
        L --> V["ç”¨æˆ·åœ¨èŠå¤©ä¸­é€‰ä¸­æ–‡æ¡£"]
        V --> W["Agent æ¨¡å¼ä¸‹å¯¹è¯"]
        W --> X["AgentService è°ƒç”¨ DocEditTool"]
        X --> Y{"æ“ä½œç±»å‹ï¼Ÿ"}
        Y -->|"read"| Y1["è¯»å–æ–‡æ¡£å…¨æ–‡"]
        Y -->|"update"| Y2["å…¨æ–‡æ›¿æ¢"]
        Y -->|"append"| Y3["æœ«å°¾è¿½åŠ "]
        Y -->|"replace"| Y4["ç‰‡æ®µæ›¿æ¢"]
        Y1 & Y2 & Y3 & Y4 --> Z["DocumentService æ‰§è¡Œæ“ä½œ"]
        Z --> ZA["SSE æ¨é€ doc_updated äº‹ä»¶"]
        ZA --> ZB["å‰ç«¯è‡ªåŠ¨åˆ·æ–°æ–‡æ¡£å†…å®¹"]
    end

    style ç”¨æˆ·ä¸Šä¼  fill:#e3f2fd,stroke:#42a5f5
    style æ–‡æ¡£æŸ¥çœ‹ç¼–è¾‘ fill:#e8f5e9,stroke:#66bb6a
    style Agentç¼–è¾‘ fill:#fff3e0,stroke:#ff9800
```

---

## 3. åç«¯è¯¦ç»†è®¾è®¡

### 3.1 æ ¸å¿ƒé…ç½® (`app/core/config.py`)

é€šè¿‡ç¯å¢ƒå˜é‡æˆ– `.env` æ–‡ä»¶é…ç½®ï¼Œç”± Pydantic Settings è‡ªåŠ¨åŠ è½½ã€‚

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `DATABASE_PATH` | `data/scholar_agent.db` | SQLite æ•°æ®åº“è·¯å¾„ |
| `UPLOAD_DIR` | `data/uploads` | ä¸Šä¼ æ–‡ä»¶å­˜å‚¨ç›®å½• |
| `OPENAI_API_KEY` | `""` | OpenAI API å¯†é’¥ |
| `OPENAI_BASE_URL` | `""` | è‡ªå®šä¹‰ API åœ°å€ï¼ˆå…¼å®¹ DeepSeek ç­‰ï¼‰ |
| `OPENAI_MODEL` | `deepseek-chat` | é»˜è®¤æ¨¡å‹ |
| `BACKEND_PORT` | `8088` | åç«¯æœåŠ¡ç«¯å£ |

**ç¯å¢ƒå˜é‡ç¤ºä¾‹ (`.env`)**:
```env
OPENAI_API_KEY=sk-xxxx
OPENAI_BASE_URL=https://api.deepseek.com/v1
OPENAI_MODEL=deepseek-chat
```

### 3.2 æ•°æ®åº“å±‚ (`app/core/database.py`)

- ä½¿ç”¨å…¨å±€å•ä¾‹è¿æ¥ï¼Œ`check_same_thread=False` æ”¯æŒå¤šçº¿ç¨‹
- å¯ç”¨ WAL æ¨¡å¼ï¼ˆWrite-Ahead Loggingï¼‰æå‡å¹¶å‘è¯»æ€§èƒ½
- å¯ç”¨å¤–é”®çº¦æŸ
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å»ºè¡¨ï¼ˆ`CREATE TABLE IF NOT EXISTS`ï¼‰

### 3.3 ä¸šåŠ¡æœåŠ¡å±‚

#### 3.3.1 SessionService (`app/services/agent_service.py` å†…ï¼‰

| æ–¹æ³• | åŠŸèƒ½ | ç‰¹æ®Šé€»è¾‘ |
|------|------|---------|
| `create_session()` | åˆ›å»ºæ–°ä¼šè¯ | è¿”å›åŒ…å« UUID çš„ä¼šè¯å¯¹è±¡ |
| `get_session()` | è·å–ä¼šè¯ | è¿”å› None å¦‚æœä¸å­˜åœ¨ |
| `list_sessions()` | åˆ—å‡ºç”¨æˆ·æ‰€æœ‰ä¼šè¯ | æŒ‰ updated_at DESC æ’åº |
| `delete_session()` | åˆ é™¤ä¼šè¯ | çº§è”åˆ é™¤å…³è”æ¶ˆæ¯ |
| `add_message()` | æ·»åŠ æ¶ˆæ¯ | é¦–æ¡ user æ¶ˆæ¯è‡ªåŠ¨æ›´æ–°ä¼šè¯æ ‡é¢˜ï¼ˆå–å‰ 50 å­—ï¼‰ |
| `get_messages()` | è·å–ä¼šè¯æ¶ˆæ¯ | æŒ‰ created_at ASC æ’åºï¼Œè‡ªåŠ¨è§£æ metadata_json |

#### 3.3.2 DocumentService (`app/services/document_service.py`)

| æ–¹æ³• | åŠŸèƒ½ | ç‰¹æ®Šé€»è¾‘ |
|------|------|---------|
| `upload_document()` | ä¸Šä¼ æ–‡æ¡£ | æ–‡ä»¶ä¿å­˜åˆ° `UPLOAD_DIR/{uuid}.ext`ï¼Œæ‰©å±•åæ˜ å°„ file_type |
| `list_documents()` | åˆ†é¡µæŸ¥è¯¢æ–‡æ¡£ | æ”¯æŒæŒ‰ folder_id ç­›é€‰ |
| `get_document()` | è·å–æ–‡æ¡£è¯¦æƒ… | |
| `delete_document()` | åˆ é™¤æ–‡æ¡£ | åŒæ—¶åˆ é™¤ç‰©ç†æ–‡ä»¶ |
| `move_document()` | ç§»åŠ¨æ–‡æ¡£åˆ°æ–‡ä»¶å¤¹ | æ›´æ–° folder_id |
| `create_folder()` | åˆ›å»ºæ–‡ä»¶å¤¹ | æ”¯æŒ parent_id åµŒå¥— |
| `list_folders()` | åˆ—å‡ºæ–‡ä»¶å¤¹ | åŠ¨æ€è®¡ç®—æ¯ä¸ªæ–‡ä»¶å¤¹çš„ document_count |
| `delete_folder()` | åˆ é™¤æ–‡ä»¶å¤¹ | æ–‡ä»¶å¤¹å†…æ–‡æ¡£çš„ folder_id ç½®ä¸º NULLï¼ˆæ–‡æ¡£ä¸åˆ é™¤ï¼‰ |
| `get_document_content()` | è·å–æ–‡æ¡£å†…å®¹ | æ”¯æŒ PDF/Word/Markdown/Text è§£æ |
| `update_document_content()` | æ›´æ–°æ–‡æ¡£å†…å®¹ | æ”¯æŒ Word/Markdown/Text æ ¼å¼å†™å…¥ |
| `append_document_content()` | è¿½åŠ æ–‡æ¡£å†…å®¹ | |
| `replace_document_content()` | æ›¿æ¢æ–‡æ¡£å†…å®¹ | |

#### 3.3.3 UserService (`app/services/user_service.py`)

| æ–¹æ³• | åŠŸèƒ½ | ç‰¹æ®Šé€»è¾‘ |
|------|------|---------|
| `get_profile()` | è·å–ç”¨æˆ·èµ„æ–™ | ç”¨æˆ·ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé»˜è®¤èµ„æ–™ |
| `update_profile()` | æ›´æ–°èµ„æ–™ | åªæ›´æ–°é null å­—æ®µ |

#### 3.3.4 AgentService (`app/services/agent_service.py`)

**æ ¸å¿ƒèŒè´£**ï¼šæ¥æ”¶ç”¨æˆ·æ¶ˆæ¯ï¼Œé©±åŠ¨ Agent æµç¨‹ï¼Œç”Ÿæˆ SSE äº‹ä»¶æµã€‚

| å‡½æ•° | æ¨¡å¼ | æµç¨‹ |
|------|------|------|
| `run_normal_chat()` | æ™®é€šæ¨¡å¼ | streamï¼ˆåˆ†å—ï¼‰â†’ done |
| `run_agent_chat()` | æ™ºèƒ½ä½“æ¨¡å¼ | planï¼ˆå« thoughtï¼‰ â†’ [step_startâ†’progressâ†’completeï¼ˆå« thought_summaryï¼‰] Ã— N â†’ stream â†’ done |

**SSE äº‹ä»¶ç”Ÿæˆ**:
```python
def _sse(self, event_type: str, data: dict) -> str:
    data["timestamp"] = datetime.now(timezone.utc).isoformat()
    return f"event: {event_type}\ndata: {json.dumps(data, ensure_ascii=False)}\n\n"
```

**Agent æ¨¡å¼ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ LLM åŠ¨æ€ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼ˆåŒ…å« thought å­—æ®µï¼‰
- æ”¯æŒåŠ¨æ€æ­¥éª¤
- æ”¯æŒæ–‡æ¡£ç¼–è¾‘ï¼ˆDocEditToolï¼‰
- æ–‡æ¡£ç¼–è¾‘åå‘é€ doc_updated äº‹ä»¶

#### 3.3.5 LLMScheduler (`app/domain/llm_scheduler/`)

**æ ¸å¿ƒèŒè´£**ï¼šç»Ÿä¸€çš„ LLM è°ƒç”¨æ¥å£ï¼Œæ”¯æŒå¤šæä¾›å•†

| æä¾›å•† | æ–‡ä»¶ | è¯´æ˜ |
|--------|------|------|
| DeepSeek | `models/deepseek.py` | DeepSeek æ¨¡å‹é›†æˆ |
| é€šä¹‰åƒé—® | `models/qwen.py` | é€šä¹‰åƒé—®æ¨¡å‹é›†æˆ |

**æœåŠ¡æ–¹æ³•**ï¼š
- `chat()`: éæµå¼è¿”å›
- `chat_stream()`: æµå¼å¯¹è¯

### 3.4 ToolHub å·¥å…·å±‚

#### 3.4.1 å·¥å…·æ³¨å†Œ

| å·¥å…· | è¯´æ˜ | å½“å‰çŠ¶æ€ | æ–‡ä»¶è·¯å¾„ |
|------|------|---------|----------|
| SearchTool | å­¦æœ¯æ£€ç´¢ï¼ˆWebæœç´¢ï¼‰ | å·²å®ç° | `tools/search/web_search.py` |
| FilterTool | ç­›é€‰ä¸æ’åºæ£€ç´¢ç»“æœ | å·²å®ç° | `tools/search/filter.py` |
| PaperDownloadTool | è®ºæ–‡ä¸‹è½½ï¼ˆæ”¯æŒç¼“å­˜ï¼‰ | å·²å®ç° | `tools/search/paper_download.py` |
| SummarizeTool | å¯¹æ£€ç´¢ç»“æœè¿›è¡Œå½’çº³æ€»ç»“ | å·²å®ç° | `tools/content/summarizer.py` |
| CitationTool | è‡ªåŠ¨ç”Ÿæˆå¼•ç”¨æ ¼å¼ | å·²å®ç° | `tools/content/citation_generator.py` |
| DocEditTool | æ–‡æ¡£å†…å®¹ç¼–è¾‘ | å·²å®ç° | `tools/document/editor.py` |
| MultiModalRAGTool | åŸºäºä¸Šä¼ æ–‡æ¡£è¿›è¡Œå¤šæ¨¡æ€é—®ç­” | å·²å®ç° | `tools/document/multimodal_parser.py` |
| LLMCallTool | é€šç”¨æ–‡æœ¬ç”Ÿæˆå·¥å…· | å·²å®ç° | `tools/llm/llm_call.py` |
| ProfileTool | ç”¨æˆ·ç”»åƒå·¥å…· | é¢„ç•™ | `tools/user/profile_builder.py` |

#### 3.4.2 å·¥å…·è¯¦ç»†è¯´æ˜

**SearchTool (Webæœç´¢)**
- åŠŸèƒ½ï¼šåœ¨äº’è”ç½‘ä¸Šæœç´¢å­¦æœ¯å†…å®¹
- å‚æ•°ï¼š
  - `query`: æœç´¢å…³é”®è¯ï¼ˆå¿…å¡«ï¼‰
  - `max_results`: æœ€å¤§è¿”å›æ•°ï¼Œé»˜è®¤ 10
  - `year_range`: å¹´ä»½èŒƒå›´ï¼Œå¯é€‰
- è¿”å›ï¼šè®ºæ–‡åˆ—è¡¨

**FilterTool (ç­›é€‰æ’åº)**
- åŠŸèƒ½ï¼šå¯¹æœç´¢ç»“æœè¿›è¡Œç­›é€‰å’Œæ’åº
- å‚æ•°ï¼š
  - `papers`: è®ºæ–‡åˆ—è¡¨ï¼ˆå¿…å¡«ï¼‰
  - `filter_criteria`: ç­›é€‰æ¡ä»¶
  - `sort_by`: æ’åºæ–¹å¼
- è¿”å›ï¼šç­›é€‰æ’åºåçš„è®ºæ–‡åˆ—è¡¨

**PaperDownloadTool (è®ºæ–‡ä¸‹è½½)**
- åŠŸèƒ½ï¼šä¸‹è½½è®ºæ–‡ PDFï¼Œæ”¯æŒç¼“å­˜é¿å…é‡å¤ä¸‹è½½
- å‚æ•°ï¼š
  - `papers`: è®ºæ–‡åˆ—è¡¨ï¼ˆå¿…å¡«ï¼‰ï¼Œæ¯ä¸ªè®ºæ–‡åŒ…å« titleã€pdfUrl
  - `user_id`: ç”¨æˆ· IDï¼ˆå¿…å¡«ï¼‰
- ç‰¹ç‚¹ï¼š
  - å¹¶è¡Œä¸‹è½½å¤šä¸ªè®ºæ–‡
  - æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å·²å­˜åœ¨ï¼ˆç¼“å­˜æ£€æŸ¥ï¼‰
  - ä¸‹è½½æ–‡ä»¶åä½¿ç”¨è®ºæ–‡æ ‡é¢˜
  - è¶…æ—¶æ—¶é—´ 60 ç§’
- è¿”å›ï¼šä¸‹è½½ç»“æœï¼ŒåŒ…å«æ˜¯å¦ä½¿ç”¨ç¼“å­˜

**SummarizeTool (å½’çº³æ€»ç»“)**
- åŠŸèƒ½ï¼šå¯¹æ£€ç´¢ç»“æœè¿›è¡Œå½’çº³æ€»ç»“
- å‚æ•°ï¼š
  - `content`: è¦æ€»ç»“çš„æ–‡æœ¬å†…å®¹ï¼ˆå¯é€‰ï¼‰
  - `papers`: è®ºæ–‡åˆ—è¡¨ï¼ˆå¯é€‰ï¼Œä¼˜å…ˆçº§é«˜äº contentï¼‰
  - `max_length`: æ‘˜è¦æœ€å¤§é•¿åº¦ï¼Œé»˜è®¤ 500
  - `style`: æ‘˜è¦é£æ ¼ï¼Œconcise/verboseï¼Œé»˜è®¤ concise
- ç‰¹ç‚¹ï¼šæ”¯æŒè‡ªåŠ¨ä»ä¹‹å‰çš„ SearchTool ç»“æœä¸­è·å– papers å‚æ•°

**CitationTool (å¼•ç”¨ç”Ÿæˆ)**
- åŠŸèƒ½ï¼šè‡ªåŠ¨ç”Ÿæˆå¼•ç”¨æ ¼å¼
- å‚æ•°ï¼š
  - `papers`: è®ºæ–‡åˆ—è¡¨ï¼ˆå¿…å¡«ï¼‰
  - `style`: å¼•ç”¨æ ¼å¼ï¼ŒGB/T 7714/APA/MLAï¼Œé»˜è®¤ GB/T 7714
- è¿”å›ï¼šæ ¼å¼åŒ–çš„å¼•ç”¨æ–‡æœ¬

**DocEditTool (æ–‡æ¡£ç¼–è¾‘)**
- åŠŸèƒ½ï¼šæ–‡æ¡£å†…å®¹ç¼–è¾‘
- å‚æ•°ï¼š
  - `doc_id`: æ–‡æ¡£ IDï¼ˆå¿…å¡«ï¼‰
  - `action`: æ“ä½œç±»å‹ï¼Œread/update/append/replaceï¼ˆå¿…å¡«ï¼‰
  - `content`: æ–°å†…å®¹ï¼ˆupdate/append æ—¶å¿…å¡«ï¼‰
  - `old_text`: è¦æ›¿æ¢çš„æ—§æ–‡æœ¬ï¼ˆreplace æ—¶å¿…å¡«ï¼‰
  - `new_text`: æ–°æ–‡æœ¬ï¼ˆreplace æ—¶å¿…å¡«ï¼‰
- æ”¯æŒæ ¼å¼ï¼š.docx/.doc (word)ã€.md (markdown)ã€.txt (text)
- è¿”å›ï¼šæ“ä½œç»“æœï¼ŒæˆåŠŸæ—¶æ¨é€ doc_updated äº‹ä»¶

**MultiModalRAGTool (å¤šæ¨¡æ€ RAG)**
- åŠŸèƒ½ï¼šåŸºäºä¸Šä¼ æ–‡æ¡£è¿›è¡Œé—®ç­”
- å‚æ•°ï¼š
  - `query`: æŸ¥è¯¢å†…å®¹ï¼ˆå¿…å¡«ï¼‰
  - `document_ids`: æ–‡æ¡£ ID åˆ—è¡¨ï¼ˆå¯é€‰ï¼Œä¸æä¾›æ—¶è‡ªåŠ¨æ£€ç´¢æ‰€æœ‰æ–‡æ¡£ï¼‰
  - `user_id`: ç”¨æˆ· IDï¼ˆå¿…å¡«ï¼‰
- ç‰¹ç‚¹ï¼š
  - æ”¯æŒè‡ªåŠ¨æ£€ç´¢ç”¨æˆ·æ‰€æœ‰æ–‡æ¡£ï¼ˆdocument_ids ä¸ºç©ºæ—¶ï¼‰
  - ä»æ–‡æ¡£ä¸­æ£€ç´¢ç›¸å…³å†…å®¹
- è¿”å›ï¼šæ£€ç´¢ç»“æœå’Œå›ç­”

**LLMCallTool (é€šç”¨æ–‡æœ¬ç”Ÿæˆ)**
- åŠŸèƒ½ï¼šç›´æ¥è°ƒç”¨å¤§æ¨¡å‹å®Œæˆæ–‡æœ¬ç”Ÿæˆä»»åŠ¡ï¼ˆè§£é‡Šæ¦‚å¿µã€å†™æ‘˜è¦ã€æ‰©å†™ã€ç¿»è¯‘ç­‰ï¼‰
- å‚æ•°ï¼š
  - `prompt`: è¦è®©å¤§æ¨¡å‹å®Œæˆçš„ä»»åŠ¡æˆ–é—®é¢˜ï¼ˆå¿…å¡«ï¼‰
  - `system_prompt`: å¯é€‰çš„ç³»ç»ŸæŒ‡ä»¤ï¼Œç”¨äºè®¾å®šè§’è‰²æˆ–æ ¼å¼
  - `temperature`: ç”Ÿæˆéšæœºæ€§ 0~1ï¼Œé»˜è®¤ 0.7
  - `max_tokens`: æœ€å¤§ç”Ÿæˆ token æ•°
- ä½¿ç”¨åœºæ™¯ï¼šå½“éœ€è¦ã€Œè®©æ¨¡å‹è‡ªç”±ç”Ÿæˆä¸€æ®µå†…å®¹ã€ä¸”ä¸é€‚åˆç”¨å…¶ä»–ä¸“ç”¨å·¥å…·æ—¶ä½¿ç”¨

#### 3.4.3 å·¥å…·å‚æ•°è‡ªåŠ¨å¡«å……

æ‰€æœ‰å·¥å…·ç»§æ‰¿è‡ª BaseToolï¼Œæ”¯æŒ `resolve_params` æ–¹æ³•ï¼Œç”¨äºä» `previous_results`ï¼ˆä¹‹å‰å·¥å…·æ‰§è¡Œç»“æœï¼‰ä¸­è‡ªåŠ¨å¡«å……ç¼ºå¤±å‚æ•°ã€‚

**å‚æ•°ä¼ é€’è§„åˆ™**ï¼š
- å·¥å…·æ‰§è¡Œç»“æœä¼šä¿å­˜åˆ° `previous_results` åˆ—è¡¨ä¸­
- åç»­å·¥å…·å¯ä»¥é€šè¿‡ `resolve_params` ä» `previous_results` ä¸­è·å–å‚æ•°
- æ”¯æŒçš„è‡ªåŠ¨å¡«å……ï¼š
  - SummarizeToolï¼šä» SearchTool/FilterTool ç»“æœä¸­è‡ªåŠ¨è·å– `papers`
  - PaperDownloadToolï¼šä» SearchTool/FilterTool ç»“æœä¸­è‡ªåŠ¨è·å– `papers`
  - CitationToolï¼šä» SearchTool/FilterTool/SummarizeTool ç»“æœä¸­è‡ªåŠ¨è·å– `papers`

### 3.5 ç¼“å­˜åŸºç¡€è®¾æ–½

#### 3.5.1 ç¼“å­˜æ¶æ„

ç¼“å­˜å±‚æ”¯æŒ Redis ç¼“å­˜å’Œå†…å­˜ç¼“å­˜ fallbackï¼Œå®ç°äº†ç¼“å­˜å‡»ç©¿ã€ç©¿é€ã€é›ªå´©é˜²æŠ¤ã€‚

**ç¼“å­˜ç®¡ç†å™¨** (`app/infrastructure/storage/redis/cache.py`)

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç¼“å­˜è£…é¥°å™¨ `@cached`
- æ”¯æŒè‡ªå®šä¹‰å‰ç¼€å’Œ TTL
- ç¼“å­˜å‡»ç©¿é˜²æŠ¤ï¼šäº’æ–¥é”é˜²æ­¢åŒä¸€ key åŒæ—¶è¯·æ±‚
- ç¼“å­˜ç©¿é€é˜²æŠ¤ï¼šç©ºå€¼ç¼“å­˜é˜²æ­¢ä¸å­˜åœ¨çš„ key ç©¿é€
- ç¼“å­˜é›ªå´©é˜²æŠ¤ï¼šéšæœº TTL é˜²æ­¢å¤§é‡ key åŒæ—¶è¿‡æœŸ

#### 3.5.2 ç¼“å­˜è£…é¥°å™¨ä½¿ç”¨

```python
from app.infrastructure.storage.redis.cache import cache_manager

@cache_manager.cached(
    prefix="paper_download",
    ttl=3600,
    protect_breakdown=True,
    protect_penetration=True,
    protect_avalanche=True
)
async def download_paper(pdf_url: str, user_id: str):
    # ä¸‹è½½é€»è¾‘
    pass
```

#### 3.5.3 ç”¨æˆ·æ•°æ®éš”ç¦»å­˜å‚¨

æ–‡æ¡£å­˜å‚¨æŒ‰ç”¨æˆ· ID åˆ†ç¦»ç›®å½•ï¼š

```
data/uploads/
â”œâ”€â”€ user1/
â”‚   â”œâ”€â”€ doc1.pdf
â”‚   â””â”€â”€ doc2.md
â”œâ”€â”€ user2/
â”‚   â””â”€â”€ doc3.docx
â””â”€â”€ ...
```

**DocumentService** (`app/application/services/document_service.py`) ä¸­çš„ `_get_user_upload_dir` æ–¹æ³•ç¡®ä¿æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„å­˜å‚¨ç›®å½•ã€‚

### 3.5 API å±‚è®¾è®¡

| è·¯ç”±å‰ç¼€ | æ–‡ä»¶ | æ¥å£æ•° | è¯´æ˜ |
|---------|------|--------|------|
| `/api/v1/chat` | `endpoints/chat.py` | 5 ä¸ª | èŠå¤© SSE + ä¼šè¯ CRUD + æ¶ˆæ¯æŸ¥è¯¢ |
| `/api/v1/documents` | `endpoints/documents.py` | 10 ä¸ª | æ–‡æ¡£ä¸Šä¼ /åˆ—è¡¨/åˆ é™¤/ç§»åŠ¨ + æ–‡ä»¶å¤¹ CRUD + å†…å®¹è¯»å†™ |
| `/api/v1/users` | `endpoints/users.py` | 2 ä¸ª | èµ„æ–™æŸ¥è¯¢/æ›´æ–° |
| `/health` | `server.py` | 1 ä¸ª | å¥åº·æ£€æŸ¥ |

> è¯¦ç»†æ¥å£è§„èŒƒè§ [API æ¥å£æ–‡æ¡£](./APIæ¥å£æ–‡æ¡£.md)

---

## 4. å‰ç«¯è¯¦ç»†è®¾è®¡

### 4.1 é¡µé¢è·¯ç”±

| è·¯ç”± | é¡µé¢æ–‡ä»¶ | è¯´æ˜ |
|------|---------|------|
| `/` | `app/page.tsx` | æ™ºèƒ½åŠ©æ‰‹ï¼ˆä¸»é¡µï¼‰ï¼Œé›†æˆèŠå¤©ã€æ–‡æ¡£ç®¡ç†ã€æ–‡æ¡£ç¼–è¾‘ |
| `/profile` | `app/profile/page.tsx` | ä¸ªäººä¸­å¿ƒ |

### 4.2 ç»„ä»¶æ ‘

```
RootLayout (layout.tsx)
â”œâ”€â”€ Navbar                          â† æ‰€æœ‰é¡µé¢å…±äº«
â””â”€â”€ Page Content
    â””â”€â”€ ChatPage (/)
        â”œâ”€â”€ Sidebar                 â† å†å²è®°å½•
        â”œâ”€â”€ PaperPanel              â† è®ºæ–‡ç®¡ç†ï¼ˆå¯æ‹–æ‹½è°ƒæ•´å®½åº¦ï¼‰
        â”‚   â”œâ”€â”€ FolderList         â† æ–‡ä»¶å¤¹åˆ—è¡¨
        â”‚   â”œâ”€â”€ UploadArea        â† ä¸Šä¼ åŒºåŸŸ
        â”‚   â”œâ”€â”€ DocumentList      â† æ–‡æ¡£åˆ—è¡¨
        â”‚   â””â”€â”€ Pagination         â† åˆ†é¡µ
        â”œâ”€â”€ DocContentPanel           â† æ–‡æ¡£å†…å®¹ï¼ˆå¯æ‹–æ‹½è°ƒæ•´å®½åº¦ï¼‰
        â”‚   â”œâ”€â”€ DocViewer/Editor  â† æ–‡æ¡£æŸ¥çœ‹/ç¼–è¾‘å™¨
        â”œâ”€â”€ ChatMessage[]           â† æ¶ˆæ¯æ°”æ³¡åˆ—è¡¨
        â”œâ”€â”€ TaskProgress            â† Agent ä»»åŠ¡è¿›åº¦å¡ç‰‡
        â””â”€â”€ InputArea               â† è¾“å…¥æ¡† + æŒ‰é’® + å¼€å…³
```

### 4.3 çŠ¶æ€ç®¡ç†

ä½¿ç”¨ React `useState` + é¡µé¢çº§çŠ¶æ€ï¼Œä¸å¼•å…¥å…¨å±€çŠ¶æ€ç®¡ç†åº“ã€‚

**ChatPage æ ¸å¿ƒçŠ¶æ€**:
| çŠ¶æ€ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `messages` | `Msg[]` | å½“å‰ä¼šè¯çš„æ¶ˆæ¯åˆ—è¡¨ |
| `input` | `string` | è¾“å…¥æ¡†å†…å®¹ |
| `isLoading` | `boolean` | æ˜¯å¦ç­‰å¾…å›å¤ |
| `sessionId` | `string \| null` | å½“å‰ä¼šè¯ ID |
| `mode` | `"normal" \| "agent"` | å¯¹è¯æ¨¡å¼ |
| `webSearch` | `boolean` | è”ç½‘æœç´¢å¼€å…³ |
| `taskSteps` | `TaskStep[]` | Agent ä»»åŠ¡æ­¥éª¤åˆ—è¡¨ |
| `agentThought` | `string` | Agent æ€è€ƒå†…å®¹ |
| `stepThoughts` | `Record<string, string>` | å„æ­¥éª¤æ€»ç»“ |
| `streamingContent` | `string` | æµå¼ç´¯ç§¯çš„å†…å®¹ |
| `selectedDocumentIds` | `string[]` | é€‰ä¸­çš„æ–‡æ¡£ ID åˆ—è¡¨ |
| `documents` | `any[]` | æ–‡æ¡£åˆ—è¡¨ |
| `folders` | `any[]` | æ–‡ä»¶å¤¹åˆ—è¡¨ |
| `selectedDoc` | `any` | å½“å‰é€‰ä¸­çš„æ–‡æ¡£ |
| `docContent` | `string \| null` | æ–‡æ¡£å†…å®¹ |
| `docEditingContent` | `string` | æ–‡æ¡£ç¼–è¾‘å†…å®¹ |

### 4.4 API å®¢æˆ·ç«¯ (`lib/api.ts`)

æ‰€æœ‰åç«¯è°ƒç”¨å°è£…åœ¨ `lib/api.ts` ä¸­ï¼Œå‰ç«¯ç»„ä»¶ä¸ç›´æ¥ä½¿ç”¨ `fetch`ã€‚

**é‡è¦**ï¼šèŠå¤© SSE è¯·æ±‚ç›´æ¥è®¿é—®åç«¯åœ°å€ï¼ˆ`BACKEND_BASE`ï¼‰ï¼Œç»•è¿‡ Next.js ä»£ç†ï¼Œé¿å…ç¼“å†²é—®é¢˜ã€‚

| å‡½æ•° | è¯´æ˜ |
|------|------|
| `fetchSSEChat()` | æ ¸å¿ƒï¼šå‘é€æ¶ˆæ¯å¹¶è§£æ SSE äº‹ä»¶æµ |
| `getSessions()` | è·å–ä¼šè¯åˆ—è¡¨ |
| `deleteSession()` | åˆ é™¤ä¼šè¯ |
| `getMessages()` | è·å–ä¼šè¯æ¶ˆæ¯å†å² |
| `uploadDocument()` | ä¸Šä¼ æ–‡æ¡£ï¼ˆFormDataï¼‰ |
| `getDocuments()` | åˆ†é¡µè·å–æ–‡æ¡£åˆ—è¡¨ |
| `deleteDocument()` | åˆ é™¤æ–‡æ¡£ |
| `createFolder()` | åˆ›å»ºæ–‡ä»¶å¤¹ |
| `getFolders()` | è·å–æ–‡ä»¶å¤¹åˆ—è¡¨ |
| `deleteFolder()` | åˆ é™¤æ–‡ä»¶å¤¹ |
| `getDocumentContent()` | è·å–æ–‡æ¡£å†…å®¹ |
| `updateDocumentContent()` | æ›´æ–°æ–‡æ¡£å†…å®¹ |
| `getProfile()` | è·å–ç”¨æˆ·èµ„æ–™ |
| `updateProfile()` | æ›´æ–°ç”¨æˆ·èµ„æ–™ |

### 4.5 SSE è§£ææµç¨‹

```typescript
// å‰ç«¯ SSE è§£ææ ¸å¿ƒé€»è¾‘
const reader = response.body.getReader();
const decoder = new TextDecoder();
let buffer = "";

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  buffer += decoder.decode(value, { stream: true });

  // æŒ‰ \n\n åˆ†å‰²äº‹ä»¶
  const parts = buffer.split("\n\n");
  buffer = parts.pop() || "";  // æœ€åä¸€æ®µå¯èƒ½ä¸å®Œæ•´ï¼Œç•™åœ¨ buffer

  for (const part of parts) {
    // è§£æ event: å’Œ data: è¡Œ
    // æ ¹æ® event type åˆ†å‘å¤„ç†ï¼ˆplan/step_start/stream/done/doc_updated ç­‰ï¼‰
  }
}
```

---

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 ER å›¾

```mermaid
erDiagram
    sessions ||--o{ messages : "has"
    folders ||--o{ documents : "contains"
    folders ||--o{ folders : "parent"
    user_profiles ||--o{ sessions : "owns"
    user_profiles ||--o{ documents : "owns"
    user_profiles ||--o{ folders : "owns"

    sessions {
        text id PK
        text user_id FK
        text title
        text mode
        text created_at
        text updated_at
    }

    messages {
        text id PK
        text session_id FK
        text role
        text content
        text msg_type
        text metadata_json
        text created_at
    }

    documents {
        text id PK
        text user_id FK
        text folder_id FK
        text filename
        text original_name
        text file_path
        int file_size
        text file_type
        text status
        text created_at
    }

    folders {
        text id PK
        text user_id FK
        text name
        text parent_id FK
        text created_at
    }

    user_profiles {
        text user_id PK
        text display_name
        text created_at
        text updated_at
    }
```

**å…³ç³»è¯´æ˜**ï¼š

- `sessions` â”€â”€< `messages`ï¼šä¸€å¯¹å¤šï¼Œçº§è”åˆ é™¤ã€‚
- `folders` â”€â”€< `documents`ï¼šä¸€å¯¹å¤šï¼Œåˆ é™¤æ–‡ä»¶å¤¹æ—¶ `folder_id` ç½® NULLã€‚
- `folders` â”€â”€< `folders`ï¼šè‡ªå¼•ç”¨ï¼Œæ”¯æŒåµŒå¥—ã€‚
- `user_profiles` ä¸ sessionsã€documentsã€folders å‡ä¸ºç”¨æˆ·ç»´åº¦å…³è”ã€‚

### 5.2 è¡¨ç»“æ„

#### sessionsï¼ˆä¼šè¯ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | TEXT | PK | UUID |
| user_id | TEXT | NOT NULL, INDEX | ç”¨æˆ· ID |
| title | TEXT | NOT NULL | ä¼šè¯æ ‡é¢˜ï¼ˆè‡ªåŠ¨ä»é¦–æ¡æ¶ˆæ¯æå–ï¼‰ |
| mode | TEXT | NOT NULL | "normal" / "agent" |
| created_at | TEXT | NOT NULL | ISO8601 |
| updated_at | TEXT | NOT NULL | ISO8601ï¼Œæ¯æ¡æ¶ˆæ¯æ›´æ–° |

#### messagesï¼ˆæ¶ˆæ¯ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | TEXT | PK | UUID |
| session_id | TEXT | FK â†’ sessions.id, INDEX | æ‰€å±ä¼šè¯ |
| role | TEXT | NOT NULL | "user" / "assistant" |
| content | TEXT | NOT NULL | æ¶ˆæ¯å†…å®¹ |
| msg_type | TEXT | NOT NULL | "text" |
| metadata_json | TEXT | NULLABLE | JSON å­—ç¬¦ä¸²ï¼ŒAgent æ¨¡å¼å­˜ papers/citations/task_plan/agent_thought/step_thoughts |
| created_at | TEXT | NOT NULL | ISO8601 |

#### documentsï¼ˆæ–‡æ¡£ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | TEXT | PK | UUID |
| user_id | TEXT | NOT NULL, INDEX | æ‰€å±ç”¨æˆ· |
| folder_id | TEXT | FK â†’ folders.id, INDEX | æ‰€å±æ–‡ä»¶å¤¹ï¼ˆå¯ä¸º NULLï¼‰ |
| filename | TEXT | NOT NULL | å­˜å‚¨æ–‡ä»¶å `{uuid}.ext` |
| original_name | TEXT | NOT NULL | åŸå§‹æ–‡ä»¶å |
| file_path | TEXT | NOT NULL | æœåŠ¡å™¨æ–‡ä»¶è·¯å¾„ |
| file_size | INTEGER | NOT NULL | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| file_type | TEXT | NOT NULL | pdf/word/markdown/text/other |
| status | TEXT | NOT NULL | uploaded/processing/ready/error |
| created_at | TEXT | NOT NULL | ISO8601 |

#### foldersï¼ˆæ–‡ä»¶å¤¹ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| id | TEXT | PK | UUID |
| user_id | TEXT | NOT NULL, INDEX | æ‰€å±ç”¨æˆ· |
| name | TEXT | NOT NULL | æ–‡ä»¶å¤¹åç§° |
| parent_id | TEXT | FK â†’ folders.id | çˆ¶æ–‡ä»¶å¤¹ï¼ˆåµŒå¥—æ”¯æŒï¼‰ |
| created_at | TEXT | NOT NULL | ISO8601 |

#### user_profilesï¼ˆç”¨æˆ·èµ„æ–™ï¼‰

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| user_id | TEXT | PK | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| display_name | TEXT | NOT NULL | æ˜¾ç¤ºåç§° |
| created_at | TEXT | NOT NULL | ISO8601 |
| updated_at | TEXT | NOT NULL | ISO8601 |

### 5.3 ç´¢å¼•

```sql
CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_messages_session ON messages(session_id);
CREATE INDEX idx_documents_user ON documents(user_id);
CREATE INDEX idx_documents_folder ON documents(folder_id);
CREATE INDEX idx_folders_user ON folders(user_id);
```

---

## 6. Agent æ ¸å¿ƒæµç¨‹

### 6.1 ä¸‰ç§å¯¹è¯æ¨¡å¼

ç³»ç»Ÿæ”¯æŒä¸‰ç§å¯¹è¯æ¨¡å¼ï¼š

| æ¨¡å¼ | è¯´æ˜ | æ ¸å¿ƒæ–¹æ³• |
|------|------|----------|
| **æ™®é€šæ¨¡å¼** (`normal`) | ç›´æ¥ä¸ LLM å¯¹è¯ï¼Œæµå¼è¾“å‡ºå›ç­” | `run_normal_chat()` |
| **æ™ºèƒ½ä½“æ¨¡å¼** (`agent`) | ReAct æ¨¡å¼ï¼Œæ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯ï¼Œè°ƒç”¨å·¥å…·å®Œæˆå¤æ‚ä»»åŠ¡ | `run_react_agent_chat()` |
| **è®ºæ–‡é—®ç­”æ¨¡å¼** (`paper_qa`) | ä»…åŸºäºå·²æœ‰æ–‡æ¡£è¿›è¡Œé—®ç­”ï¼Œè‡ªåŠ¨æ£€ç´¢æ‰€æœ‰æ–‡æ¡£ | `run_paper_qa_chat()` |

### 6.2 æ™®é€šæ¨¡å¼ (`run_normal_chat`)

```
è¾“å…¥: message, session_id, history, document_ids, provider, model
  â”‚
  â”œâ”€ è°ƒç”¨ LLM æµå¼ç”Ÿæˆå›ç­”
  â”œâ”€ åˆ†å—æµå¼è¾“å‡º
  â”‚   â””â”€ yield SSE: stream Ã— N
  â”œâ”€ å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯åˆ° DB
  â””â”€ yield SSE: done
```

### 6.3 ReAct æ™ºèƒ½ä½“æ¨¡å¼ (`run_react_agent_chat`)

```
è¾“å…¥: message, session_id, user_id, history, document_ids, llm_provider, llm_model, llm_temperature, llm_max_tokens, llm_top_p
  â”‚
  â”œâ”€ [åˆå§‹åŒ–]
  â”‚   â”œâ”€ æ„å»º messagesï¼ˆåŒ…å« system_prompt + å†å²æ¶ˆæ¯ï¼‰
  â”‚   â”œâ”€ åˆå§‹åŒ– previous_results ç”¨äºå·¥å…·é—´å‚æ•°ä¼ é€’
  â”‚   â””â”€ åˆå§‹åŒ– iteration = 0
  â”‚
  â”œâ”€ [ReAct å¾ªç¯] while iteration < max_iterations:
  â”‚   â”‚
  â”‚   â”œâ”€ [æ€è€ƒé˜¶æ®µ]
  â”‚   â”‚   â”œâ”€ è°ƒç”¨ LLM ç”ŸæˆåŒ…å« <thought> å’Œ <action> æˆ– <final_answer> çš„å“åº”
  â”‚   â”‚   â””â”€ æå– <thought> å†…å®¹å¹¶æ¨é€
  â”‚   â”‚
  â”‚   â”œâ”€ [æ£€æŸ¥æ˜¯å¦å®Œæˆ]
  â”‚   â”‚   â”œâ”€ å¦‚æœå­˜åœ¨ <final_answer>ï¼Œæå–å†…å®¹å¹¶æµå¼è¾“å‡º
  â”‚   â”‚   â””â”€ break å¾ªç¯
  â”‚   â”‚
  â”‚   â”œâ”€ [è¡ŒåŠ¨é˜¶æ®µ]
  â”‚   â”‚   â”œâ”€ æå– <action> ä¸­çš„å·¥å…·åå’Œå‚æ•°
  â”‚   â”‚   â”œâ”€ è§£æå·¥å…·è°ƒç”¨å‚æ•°ï¼ˆæ”¯æŒå­—ç¬¦ä¸²ã€æ•°å­—ã€æ•°ç»„ã€å¯¹è±¡ï¼‰
  â”‚   â”‚   â”œâ”€ è°ƒç”¨å·¥å…·çš„ resolve_params æ–¹æ³•ï¼Œä» previous_results è‡ªåŠ¨å¡«å……ç¼ºå¤±å‚æ•°
  â”‚   â”‚   â”œâ”€ æ‰§è¡Œå·¥å…·è°ƒç”¨
  â”‚   â”‚   â””â”€ å°†å·¥å…·ç»“æœä¿å­˜åˆ° previous_results
  â”‚   â”‚
  â”‚   â”œâ”€ [è§‚å¯Ÿé˜¶æ®µ]
  â”‚   â”‚   â”œâ”€ å°†å·¥å…·ç»“æœç”¨ <observation> æ ‡ç­¾åŒ…è£¹
  â”‚   â”‚   â””â”€ æ·»åŠ åˆ° messages ä¸­
  â”‚   â”‚
  â”‚   â””â”€ iteration += 1
  â”‚
  â”œâ”€ [å­˜å‚¨ä¸å®Œæˆ]
  â”‚   â”œâ”€ å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯åˆ° DBï¼ˆå« metadataï¼‰
  â”‚   â””â”€ yield SSE: done
```

### 6.4 ReAct æ¨¡å¼ XML æ ‡ç­¾æ ¼å¼

LLM å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ XML æ ‡ç­¾æ ¼å¼è¾“å‡ºï¼š

| æ ‡ç­¾ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `<thought>` | æ€è€ƒè¿‡ç¨‹ | `<thought>æˆ‘éœ€è¦å…ˆæœç´¢ç›¸å…³è®ºæ–‡</thought>` |
| `<action>` | å·¥å…·è°ƒç”¨ï¼Œæ ¼å¼ï¼š`tool_name(param1="value1", param2="value2")` | `<action>SearchTool(query="æ·±åº¦å­¦ä¹ ")</action>` |
| `<observation>` | å·¥å…·æ‰§è¡Œç»“æœï¼ˆç³»ç»Ÿè¿”å›ï¼‰ | `<observation>{"papers": [...]}</observation>` |
| `<final_answer>` | æœ€ç»ˆç­”æ¡ˆ | `<final_answer>è¿™æ˜¯æœ€ç»ˆç­”æ¡ˆ...</final_answer>` |

### 6.5 å·¥å…·å‚æ•°è‡ªåŠ¨å¡«å……æœºåˆ¶

å·¥å…·å®ç° `resolve_params` æ–¹æ³•ï¼Œæ”¯æŒä» `previous_results` ä¸­è‡ªåŠ¨è·å–ç¼ºå¤±å‚æ•°ï¼š

```python
def resolve_params(self, params: dict, previous_results: list) -> dict:
    """è‡ªåŠ¨å¡«å……ç¼ºå¤±çš„å‚æ•°"""
    # å¦‚æœ papers å‚æ•°ç¼ºå¤±ï¼Œä»ä¹‹å‰çš„ SearchTool ç»“æœä¸­è·å–
    if "papers" not in params and previous_results:
        for result in reversed(previous_results):
            if "papers" in result:
                params["papers"] = result["papers"]
                break
    return params
```

### 6.6 è®ºæ–‡é—®ç­”æ¨¡å¼ (`run_paper_qa_chat`)

```
è¾“å…¥: message, session_id, user_id, history
  â”‚
  â”œâ”€ [è‡ªåŠ¨è·å–æ‰€æœ‰æ–‡æ¡£]
  â”‚   â”œâ”€ è°ƒç”¨ document_service.list_documents è·å–ç”¨æˆ·æ‰€æœ‰æ–‡æ¡£
  â”‚   â””â”€ å°†æ‰€æœ‰æ–‡æ¡£ ID ä½œä¸º selected_doc_ids
  â”‚
  â”œâ”€ [è°ƒç”¨ MultiModalRAGTool]
  â”‚   â”œâ”€ ä¼ å…¥ query å’Œæ‰€æœ‰æ–‡æ¡£ ID
  â”‚   â””â”€ ä»æ‰€æœ‰æ–‡æ¡£ä¸­æ£€ç´¢ç›¸å…³å†…å®¹
  â”‚
  â”œâ”€ [ç”Ÿæˆå›ç­”]
  â”‚   â”œâ”€ åŸºäºæ£€ç´¢ç»“æœè°ƒç”¨ LLM ç”Ÿæˆå›ç­”
  â”‚   â””â”€ æµå¼è¾“å‡ºå›ç­”
  â”‚
  â””â”€ å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯åˆ° DB
```

---

## 7. SSE æµå¼åè®®

### 7.1 æœåŠ¡ç«¯ SSE ç”Ÿæˆæµç¨‹

```mermaid
flowchart TD
    A[chat ç«¯ç‚¹æ”¶åˆ° POST] --> B[add_message user]
    B --> C{mode?}
    C -->|normal| D[run_normal_chat ç”Ÿæˆå™¨]
    C -->|agent| E[run_agent_chat ç”Ÿæˆå™¨]
    D --> F[stream Ã— N]
    E --> F
    F --> G[add_message assistant]
    G --> H[yield done äº‹ä»¶]
    H --> I[StreamingResponse ç»“æŸ]
```

### 7.2 ä¼ è¾“æ ¼å¼

```
event: {event_type}\n
data: {json_object}\n
\n
```

### 7.3 äº‹ä»¶ç±»å‹

| äº‹ä»¶ | data å­—æ®µ | å‰ç«¯å¤„ç† |
|------|-----------|----------|
| `plan` | `plan: [], thought: string` | æ¸²æŸ“ä»»åŠ¡è®¡åˆ’å¡ç‰‡ï¼Œæ˜¾ç¤º thought |
| `step_start` | `step_id: string, action: string` | å¯¹åº”æ­¥éª¤çŠ¶æ€å˜ä¸º "running" |
| `step_progress` | `step_id: string, progress: number, message: string` | æ›´æ–°è¿›åº¦æ¡å’Œæç¤ºæ–‡å­— |
| `step_complete` | `step_id: string, result: object, thought_summary: string` | å¯¹åº”æ­¥éª¤çŠ¶æ€å˜ä¸º "done"ï¼Œæ˜¾ç¤ºæ­¥éª¤æ€»ç»“ |
| `stream` | `content: string` | ç´¯åŠ å†…å®¹åˆ° streamingContentï¼Œå®æ—¶æ¸²æŸ“ |
| `doc_updated` | `doc_id: string` | åˆ·æ–°å¯¹åº”æ–‡æ¡£å†…å®¹ |
| `done` | `content: string` | æ ‡è®°å®Œæˆï¼Œä¿å­˜æ¶ˆæ¯ |

---

## 8. å¼€å‘è§„èŒƒ

### 8.1 ç¯å¢ƒå˜é‡

åç«¯ `.env` ç¤ºä¾‹ï¼š

```env
# LLM é…ç½®
OPENAI_API_KEY=your_api_key_here
OPENAI_BASE_URL=https://api.deepseek.com/v1
OPENAI_MODEL=deepseek-chat

# åç«¯é…ç½®
BACKEND_PORT=8088
```

å‰ç«¯ `.env.local` ç¤ºä¾‹ï¼š

```env
NEXT_PUBLIC_BACKEND_BASE=http://localhost:8088
```

### 8.2 å¯åŠ¨æ–¹å¼

**åç«¯å¯åŠ¨**:
```bash
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
python server.py
```

**å‰ç«¯å¯åŠ¨**:
```bash
cd frontend
npm install
npm run dev
```

æˆ–ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„ `start.sh` ä¸€é”®å¯åŠ¨ã€‚

